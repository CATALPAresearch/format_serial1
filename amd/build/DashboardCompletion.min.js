/**
 * DashboardCompletion
 *
 * @module     format/ladtopics
 * @package    format_ladtopics
 * @class      DashboardCompletion
 * @copyright  2020 Niels Seidel, niels.seidel@fernuni-hagen.de
 * @description Shows per course section a row of rectangles indicating the completion of assigned activities.
 * @license    MIT
 * @since      3.1
 * 
 * @todo
 * - display repetition of activities
 * - provide additional information for each activity using a popover or tooltip
 * - fix empty section names
 */
define(["jquery",M.cfg.wwwroot+"/course/format/ladtopics/lib/build/vue.min.js",M.cfg.wwwroot+"/course/format/ladtopics/amd/src/utils/Utils.js"],(function(e,n,t){return t=new t,n.component("dashboard-completion",{props:["course","log","milestones"],data:function(){return{sections:[],info:"",current:{id:0,section:0},milestoneResources:[]}},mounted:function(){var e=this;t.get_ws("completionprogress",{courseid:parseInt(this.course.id,10)},(function(n){try{e.draw(JSON.parse(n.completions))}catch(n){console.error(n)}})),this.getMilestoneResources()},methods:{updateResources:function(e){this.milestones=e,this.getMilestoneResources()},draw:function(e){this.sections=function(e,n){var t=[];for(var s in e)t[e[s][n]]=t[e[s][n]]||[],t[e[s][n]].push(e[s]);return t.filter((function(e){return null!==e}))}(e,"section")},setCurrent:function(e,n){this.current={id:e,section:n},this.$emit("log","dashboard_completion_item_hover",{url:this.getLink(),completion:this.getCurrent().completion})},getCurrent:function(){return this.sections[this.current.section][this.current.id]},getLink:function(e){return e=null==e?this.getCurrent():e,M.cfg.wwwroot+"/mod/"+e.type+"/view.php?id="+e.id},getStatus:function(e){return 0===(e=null==e?this.getCurrent():e).completion?'<i class="fa fa-times-square"></i>Nicht abgeschlossen':'<i class="fa fa-check"></i> Abgeschlossen'},getMilestoneResources:function(){this.milestoneResources=[];for(var e=0;this.milestones.length;e++)for(j=0;j<this.milestones[e].resources.length;j++){let n=parseInt(this.milestones[e].resources[j].instance_id,10);void 0!==n&&this.milestoneResources.push(n)}},isPartOfMilestone:function(e){return-1!==this.milestoneResources.indexOf(parseInt(e,10))},trackClick:function(){let e=this.getCurrent();this.$emit("log","dashboard_completion_item_click",{type:e.type,instance:e.id})}},template:'\n                <div id="dashboard-completion">\n                    <p class="w-75" style="font-size:0.9em">Anhand dieser Balken können Sie erkennen, welche Lernangebote Sie bereits genutzt haben. Jedes Kästchen steht für ein Lernangebot, welches Sie durch einen Klick aufrufen können.</p>\n                    <div v-for="(section, sIndex) in sections" class="row">\n                        <div class="col-3" style="font-size:0.9em">{{ section[0].sectionname }}</div>\n                        <div class="col-9">\n                            <span v-for="(m, index) in section">\n                                <a v-bind:href="getLink()" :style="isPartOfMilestone(m.instance) ? \'border-bottom: 4px solid #333;\':\'\'" v-on:click="trackClick()" v-if="m.type !== \'label\' && m.type !== \'headline\'" :class="m.completion==1 ? \'rect-green completion-rect\' : \'rect-blue completion-rect\'" @mouseover="setCurrent(index, sIndex)"></a>\n                            </span>\n                        </div>\n                    </div>\n                    <div class="row">\n                        <div class="col-3"></div>\n                        <div class="col-9">\n                            <a v-bind:href="getLink()" v-on:click="trackClick()">\n                                <span v-if="getCurrent().completion === 0">\n                                    <i class="fa fa-times-rectangle"></i> {{ getCurrent().name }}, nicht abgeschlossen\n                                </span>\n                                <span v-if="getCurrent().completion !== 0">\n                                    <i class="fa fa-check"></i> {{ getCurrent().name }}, abgeschlossen\n                                </span>\n                            </a>\n                        </div>\n                    </div>\n                </div>'})}));