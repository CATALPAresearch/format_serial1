/**
 * DashboardOverview
 *
 * @module     format/ladtopics
 * @package    format_ladtopics
 * @class      DashboardOverview
 * @copyright  2020 Niels Seidel, niels.seidel@fernuni-hagen.de
 * @description Shows per course section a row of rectangles indicating the completion of assigned activities.
 * @license    MIT
 * @since      3.1
 * 
 * @todo
 * - display repetition of activities
 * - provide additional information for each activity using a popover or tooltip
 * - fix empty section names
 */
define(["jquery",M.cfg.wwwroot+"/course/format/ladtopics/lib/build/vue.min.js",M.cfg.wwwroot+"/course/format/ladtopics/amd/src/utils/Utils.js"],(function(e,n,t){return t=new t,n.component("dashboard-overview",{props:["course","log","milestones"],data:function(){return{color:{orange:"#e79c63",green:"#88c2b7",yellow:"#e7c87a"},sections:[],sectionnames:[],activities:[],info:"",current:{id:0,section:0},milestoneResources:[],stats:[],sumScores:{},reflections:[],currentReflectionSection:0,currentGoal:"mastery",goals:{mastery:{assign_completion:{low:61,med:90},assign_score:{low:61,med:90},quiz_completion:{low:50,med:90},quiz_score:{low:60,med:300}},passing:{assign_completion:{low:30,med:80},assign_score:{low:50,med:80},quiz_completion:{low:30,med:80},quiz_score:{low:50,med:80}},overview:{assign_completion:{low:10,med:40},assign_score:{low:40,med:70},quiz_completion:{low:10,med:40},quiz_score:{low:50,med:70}}}}},mounted:function(){var e=this;t.get_ws("overview",{courseid:parseInt(this.course.id,10)},(function(n){try{console.log("input activities::",JSON.parse(n.activities)),console.log("input completions::",JSON.parse(n.completions)),e.sections=e.groupBy(JSON.parse(n.completions),"section"),e.stats=e.calcStats()}catch(n){console.error(n)}})),this.loadReflection()},methods:{groupBy:function(e,n){var t=[];for(var s in e)t[e[s][n]]=t[e[s][n]]||[],t[e[s][n]].push(e[s]);return t.filter((function(e){return null!==e}))},getSectionName:function(e){},setCurrent:function(e,n){this.current={id:e,section:n},this.$emit("log","dashboard_overview_item_hover",{url:this.getLink(),completion:this.getCurrent().completion})},getCurrent:function(){return this.sections[this.current.section][this.current.id]},getLink:function(e){return e=null==e?this.getCurrent():e,M.cfg.wwwroot+"/mod/"+e.type+"/view.php?id="+e.id},getStatus:function(e){return 0===(e=null==e?this.getCurrent():e).completion?'<i class="fa fa-times-square"></i>Nicht abgeschlossen':'<i class="fa fa-check"></i> Abgeschlossen'},getMilestoneResources:function(){this.milestoneResources={};for(var e=0;this.milestones.length;e++)for(j=0;j<this.milestones[e].resources.length;j++){let n=parseInt(this.milestones[e].resources[j].instance_id,10);void 0!==n&&this.milestoneResources.push(n)}},isPartOfMilestone:function(e){return-1!==this.milestoneResources.indexOf(parseInt(e,10))},trackClick:function(){let e=this.getCurrent();this.$emit("log","dashboard_overview_item_click",{type:e.type,instance:e.id})},calcStats:function(){stats=[];for(var e=0;e<this.sections.length;e++)for(var n=this.sections[e],t=0;t<n.length;t++)null==stats[n[t].section]&&(stats[n[t].section]={}),null==stats[n[t].section][n[t].type]&&(this.sectionnames[n[t].section]=n[t].sectionname,stats[n[t].section][n[t].type]={type:n[t].type,count:0,achieved_score:0,max_score:0,complete:0}),n[t].count=null==n[t].count?1:n[t].count,stats[n[t].section][n[t].type].count="assign"==n[t].type?parseInt(n[t].count,10):stats[n[t].section][n[t].type].count+1,stats[n[t].section][n[t].type].achieved_score+=null!=n[t].achieved_score?parseInt(n[t].achieved_score,10):0,stats[n[t].section][n[t].type].max_score+=null!=n[t].max_score?parseInt(n[t].max_score,10):0,stats[n[t].section][n[t].type].complete+=null!=n[t].submission_time?1:0;let s=[],i={assign:{count:0,complete:0,achieved_score:0,max_score:0},quiz:{count:0,complete:0,achieved_score:0,max_score:0}};for(t=0;t<stats.length;t++)el={sectionname:this.sectionnames[t].replace(":",":\n"),id:t},stats[t].page&&(el.page={count:stats[t].page.count,complete:stats[t].page.complete}),stats[t].assign&&(el.assign={count:stats[t].assign.count,complete:stats[t].assign.complete,achieved_score:stats[t].assign.achieved_score,max_score:stats[t].assign.max_score},i.assign.count+=stats[t].assign.count,i.assign.complete+=stats[t].assign.complete,i.assign.achieved_score+=stats[t].assign.achieved_score,i.assign.max_score+=stats[t].assign.max_score),stats[t].quiz&&(el.quiz={count:stats[t].quiz.count,complete:stats[t].quiz.complete,achieved_score:stats[t].quiz.achieved_score,max_score:stats[t].quiz.max_score},i.quiz.count+=stats[t].quiz.count,i.quiz.complete+=stats[t].quiz.complete,i.quiz.achieved_score+=stats[t].quiz.achieved_score,i.quiz.max_score+=stats[t].quiz.max_score),s.push(el);return console.log("calccc: ",s),this.sumScores=i,s},getRatio:function(e,n,t=0){if(parseInt(e)>0&&parseInt(n)>0){var s=parseInt(e)/parseInt(n)*100;return t>0&&s>t?t:s}return 0},getBarColor:function(e,n){return n<this.goals[this.currentGoal][e].low?this.color.orange:n>this.goals[this.currentGoal][e].med?this.color.green:this.color.yellow},setCurrentReflectionSection:function(e){this.currentReflectionSection=e},switchGoal(e){this.currentGoal=e.target.value,this.$forceUpdate()},loadReflection:function(){var e=this;t.get_ws("reflectionread",{courseid:parseInt(this.course.id,10)},(function(n){try{e.reflections=JSON.parse(n.data),console.log("Reflection-data ",e.reflections)}catch(n){console.error(n)}}))},saveReflection(e){var n=this;t.get_ws("reflectioncreate",{data:{course:parseInt(this.course.id,10),section:parseInt(this.currentReflectionSection,10),reflection:this.reflection}},(function(e){try{n.loadReflection()}catch(e){console.log(e)}}))},sectionMinimumAchived:function(e){var n=this.stats.filter((function(n){return n.id==e}))[0],t=n.hasOwnProperty("quiz")?n.quiz.complete/n.quiz.count*100:0,s=n.hasOwnProperty("assign")?n.assign.complete/n.assign.count*100:0;return console.log("bam",n.hasOwnProperty("quiz")?n.quiz.complete+"__"+n.quiz.count:0),console.log(n),t>10&&s>10||t>30||s>30},getNumberOfReflectedSections:function(){var e=[];for(var n in this.reflections)e.push(this.reflections[n].section);return(e=[...new Set(e)]).length},reflectionOfSectionDone:function(e){for(var n in this.reflections)if(parseInt(this.reflections[n].section,10)==e)return!0;return!1}},template:'\n            <div id="dashboard-overview">\n                    <h3 hidden>Semesterübersicht</h3>\n                    <p class="w-75"></p>\n                    <div class="row mb-3 form-group">\n                        <div class="col-3">\n                            <label for="select-goal">Mein Ziel:</label>\n                            <select \n                                id="select-goal" \n                                @change="switchGoal($event)"\n                                class="pt-1 pb-1 fa-caret-down" aria-label=".form-select-sm example" \n                                style="display:inline-block;border:none;background-color:#ddeeff;width:120px;height:20px;font-weigth:bold;font-size:12px;">\n                                <option selected value="mastery">den Kurs meistern</option>\n                                <option value="passing">den Kurs bestehen</option>\n                                <option value="overview">einen Überblick erhalten</option>\n                            </select>\n                        </div>\n                        <div class="col-2"></div>\n                        <div class="col-4 form-group">\n                            <nav hidden class="nav nav-pills nav-sm flex-column flex-sm-row">\n                                <label for="select-timerange">Zeitraum filtern:</label>\n                                <div class="flex-sm-fill text-sm-center nav-link active">etzten 24 Stunden</div>\n                                <div class="text-sm-center nav-link">7 Tage</div>\n                                <div class="flex-sm-fill text-sm-center ">14 Tage</div>\n                                <div class="flex-sm-fill text-sm-center nav-link">letzter Monat</div>\n                                <div class="flex-sm-fill text-sm-center nav-link">Semester</div>\n                            </nav>\n                            <select hidden id="select-timerange" class="form-control w-50 form-control-sm" aria-label=".form-select-sm example"  style="margin-left:15px;display:inline-block;">\n                                <option selected>letzten 24 Stunden</option>\n                                <option value="1">letzten 7 Tage</option>\n                                <option value="2">letzten 14 Tage</option>\n                                <option value="3">letzter Monat</option>\n                                <option value="3">seit Semesterbeginn</option>\n                            </select>\n                        </div>\n                    </div>\n                    <div class="row col-10 mb-2">    \n                        <span class="col-2" style="text-align:right;"><strong>Kurseinheit</strong></span>\n                        <span class="col-2"><strong>Kurstext lesen und verstehen</strong></span>\n                        <span class="col-2"><strong>Selbsttests lösen und Lerninhalte anwenden</strong></span>\n                        <span class="col-2"><strong>Einsendeaufgaben bearbeiten, um in der Klausur Zeit sparen</strong></span>\n                        <span class="col-2"><strong>Abschlussreflexion bearbeiten und besser in der Klausur abschneiden</strong></span>    \n                    </div>\n                    <div v-for="(section, sIndex) in stats" class="row col-10 mb-0">\n                        <div class="col-2 mb-1" style="border: solid #111 0pt;text-align:right;">\n                            \x3c!-- Course Unit --\x3e\n                            {{ section.sectionname }}\n                        </div>\n                        <div class="col-2 mb-1" style="border: solid #111 0pt;">\n                            \x3c!-- Longpage --\x3e\n                            -\n                        </div>\n                        <div class="col-2 mb-1" style="border: solid #111 0pt;">\n                            \x3c!-- Self Assessment --\x3e\n                            <span v-if="section.quiz" class="mb-1" style="display:block;position:relative;width:100px;height:15px;background-color:#eee;">\n                                <span :style="\'position:absolute;background-color:\'+getBarColor(\'quiz_completion\', getRatio(section.quiz.complete, section.quiz.count))+\';display:block;height:100%;width:\'+ getRatio(section.quiz.complete, section.quiz.count, 100) +\'%;\'">\n                                </span>\n                                <span class="p-1" style="z-index:10;position:absolute;color:#333;font-size:0.7rem;vertical-align:middle;display:block;height:100%;">\n                                    {{ section.quiz.complete }} von {{ section.quiz.count }} bearbeitet\n                                </span>\n                            </span>\n                            <span v-if="section.quiz" class="mb-1" style="display:block;position:relative;width:100px;height:15px;background-color:#eee;">\n                                <span :style="\'position:absolute;background-color:\'+getBarColor(\'quiz_score\', getRatio(section.quiz.achieved_score, section.quiz.max_score))+\';display:block;height:100%;width:\'+ getRatio(section.quiz.achieved_score, section.quiz.max_score, 100) +\'%;\'">\n                                </span>\n                                <span class="p-1" style="z-index:10;position:absolute;color:#333;font-size:0.7rem;vertical-align:middle;display:block;height:100%;">\n                                    {{ Math.round(getRatio(section.quiz.achieved_score, section.quiz.max_score), 100) }}% korrekt\n                                </span>\n                            </span>\n                        </div>\n                        <div class="col-2 mb-1" style="border: solid #111 0pt; height:40px;">\n                            \x3c!-- Submission tasks --\x3e\n                            <span v-if="section.assign" class="mb-1" style="display:block;position:relative;width:100px;height:15px;background-color:#eee;">\n                                <span :style="\'position:absolute;background-color:\'+getBarColor(\'assign_completion\', getRatio(section.assign.complete, section.assign.count))+\';display:block;height:100%;width:\'+ getRatio(section.assign.complete, section.assign.count, 100) +\'%;\'">\n                                </span>\n                                <span class="p-1" style="z-index:10;position:absolute;color:#333;font-size:0.7rem;vertical-align:middle;display:block;height:100%;">\n                                    {{ section.assign.complete }} von {{ section.assign.count }} bearbeitet\n                                </span>\n                            </span>\n                            <span v-if="section.assign" class="mb-1" style="display:block;position:relative;width:100px;height:15px;background-color:#eee;">\n                                <span :style="\'position:absolute;background-color:\'+getBarColor(\'assign_score\', getRatio(section.assign.achieved_score, section.assign.max_score))+\';display:block;height:100%;width:\'+ getRatio(section.assign.achieved_score, section.assign.max_score, 100) +\'%;\'">\n                                </span>\n                                <span class="p-1" style="z-index:10;position:absolute;color:#333;font-size:0.7rem;vertical-align:middle;display:block;height:100%;">\n                                    {{ Math.round(getRatio(section.assign.achieved_score, section.assign.max_score), 0) }}% korrekt\n                                </span>\n                            </span>\n                        </div>\n                        <div class="col-2 mb-1" style="border: solid #111 0pt;">\n                           \x3c!-- Reflection task --\x3e\n                           <div \n                                class="btn btn-default" \n                                :style="\'display:block; width:130px; height:30px; color:#222; background-color:\' + (sectionMinimumAchived(section.id) ? (reflectionOfSectionDone(section.id) ? color.green : color.orange) : \'#ddd\') +\';\' "\n                                data-toggle="modal" \n                                data-target="#refelctionModal" \n                                @click="setCurrentReflectionSection(section.id)">\n                                Reflexion\n                            </div>\n                        </div>\n                    </div>\n                    <div class="row col-10 mb-3" style="">\n                        <span class="col-2">Lernfortschritt insgesamt</span>\n                        <span class="col-2">xxx Minuten gelesen</span>\n                        <span class="col-2">{{ getRatio(sumScores.quiz.complete, sumScores.quiz.count) }}% erledigt<br></span>\n                        <span class="col-2">{{ getRatio(sumScores.assign.complete, sumScores.assign.count) }}% erledigt<br></span>\n                        <span class="col-2">{{ getNumberOfReflectedSections() }}/{{ sectionnames.length }} erledigt</span>  \n                    </div>\n                    <div class="right col-8 small mt-3 mr-3">\n                        Beachten Sie auch die anderen Lernmaterialien wie die <a href="#">Virtuellen Treffen</a>, <a href="#">Praktischen Übungen</a> und <a href="#">Prüfungsvorbereitungen</a>\n                    </div>\n                    \n\n\n\n                    \x3c!-- MODAL POPUP for REFLECTIONS --\x3e\n                    <div class="modal fade" id="refelctionModal" tabindex="-1" role="dialog" aria-labelledby="refelctionModalLabel" aria-hidden="true">\n                        <div class="modal-dialog modal-lg modal-dialog-centered" role="document">\n                            <form @submit.prevent="saveReflection">\n                            <div class="modal-content">\n                                <div class="modal-header">\n                                    <h5 class="modal-title" id="refelctionModalLabel">Abschlussreflektion</h5>\n                                    <button type="button" class="close" data-dismiss="modal" aria-label="Schließen">\n                                        <span aria-hidden="true">&times;</span>\n                                    </button>\n                                </div>\n                                <div class="modal-body">\n                                    <div class="mb-3 lead">\n                                    \x3c!-- \n                                    This assignment is designed to help you pause for a moment and think about your learning progress in the Devices and Processes unit. \n                                    It is important that you answer these questions truthfully so that you can properly direct your learning.\n                                    --\x3e\n                                    Diese Aufgabe soll Ihnen helfen einen Moment innezuhalten und über Ihren Lernfortschritt in der Kurseinheit xxx nachzudenken. \n                                    Es ist wichtig, dass Sie diese Aufgaben wahrheitsgemäß beantworten damit Sie Ihr Lernen danach ausrichten können.\n                                    <br>\n                                    <ul>\n                                    <li>\n                                    \x3c!-- \n                                        After completing various self-assessment tasks and receiving feedback, are you satisfied with the results? \n                                        Did you develop knowledge of the topic consistent with your learning goals? \n                                    --\x3e\n                                        Sind Sie nach dem Abschluss mehrerer Selfsttest- oder Einsendeaufgaben mit den Ergebnissen zufrieden?\n                                        Konnten Sie Ihr Wissen zum Thema der Kurseinheit im hins\n                                    </li>\n                                    <li>\n                                    \x3c!-- \n                                        Is it necessary to re-study Devices and Processes unit? \n                                        Is there a need to change the current way of learning and planning, \n                                        to better cope with the next learning chapter (allocate more time for \n                                        learning, employ different approach, study material with more attention...)?\n                                    --\x3e\n                                        Ist es notwendig, die Kurseinheit noch einmal zu wiederholen? \n                                        Ist es erforderlich, die derzeitige Vorgehensweise beim Lernen und Planen zu ändern, um die anderen Kurseinheiten besser bewältigen zu können \n                                        (mehr Zeit für das Lernen einplanen, eine andere Lernstrategie wählen, das Material mit mehr Aufmerksamkeit studieren...)?\n                                        </li>\n                                    <li>\n                                    \x3c!--\n                                        Can you name any problem that has hindered your results and knowledge \n                                        (lack of time, poor planning, prior knowledge, inability to understand a particular concept...)? \n                                        Did you discover any faults in what you had previously believed to be right? Can you overcome it for the next unit?\n                                    --\x3e\n                                    Können Sie ein Problem nennen, das Ihre Lernergebnisse und Ihren Wissenserwerb beeinträchtigt haben (Zeitmangel, schlechte Planung, Vorwissen, Unfähigkeit, ein bestimmtes Konzept zu verstehen...)? \n                                    Haben Sie Fehler in dem entdeckt, was Sie bisher für richtig hielten? Können Sie diese bei der nächsten Kurseinheit beheben?\n                                        </li>\n                                    </ul>\n                                    \x3c!-- Write a short note of no more than 300 words (approximately 100 per question) to this questions and submit it in the box provided below.   --\x3e\n                                    Schreiben Sie eine kurze Notiz von nicht mehr als 300 Wörtern (ca. 100 Wörter pro Frage) zu diesen Fragen in das folgende Textfeld.\n                                    </div>\n                                    <textarea v-model="reflection" class="mt-2" style="width:100%; min-height:150px;font-size:20px;padding:10px;"></textarea>\n                                    \n                                    <input type="hidden" name="version" :value="1"/> \n                                    Sec: {{ currentReflectionSection }}\n                                    <div class="mt-2" v-for="(ref, index) in reflections">\n                                        <div v-if="ref.section==currentReflectionSection">\n                                            <em>Version {{ index }} vom {{ ref.timecreated }}</em><br>\n                                            {{ ref.reflection }}\n                                        </div>\n                                    </div>\n                                </div>\n                                <div class="modal-footer">\n                                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Schließen</button>\n                                    <button type="submit" class="btn btn-primary">Speichern</button>\n                                </div>\n                            </div>\n                            </form>\n                        </div>\n                    </div>\n                </div>    \n            '})}));