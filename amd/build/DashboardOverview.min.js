/**
 * DashboardOverview
 *
 * @module     format/ladtopics
 * @package    format_ladtopics
 * @class      DashboardOverview
 * @copyright  2020 Niels Seidel, niels.seidel@fernuni-hagen.de
 * @description Shows per course section a row of rectangles indicating the completion of assigned activities.
 * @license    MIT
 * @since      3.1
 * 
 * @todo
 * - display repetition of activities
 * - provide additional information for each activity using a popover or tooltip
 * - fix empty section names
 */
define(["jquery",M.cfg.wwwroot+"/course/format/ladtopics/lib/build/vue.min.js",M.cfg.wwwroot+"/course/format/ladtopics/amd/src/utils/Utils.js"],(function(e,s,t){return t=new t,s.component("dashboard-overview",{props:["course","log","milestones"],data:function(){return{sections:[],sectionnames:[],activities:[],info:"",current:{id:0,section:0},milestoneResources:[],stats:[],test:0}},mounted:function(){var e=this;t.get_ws("overview",{courseid:parseInt(this.course.id,10)},(function(s){try{console.log("input activities::",JSON.parse(s.activities)),console.log("input completions::",JSON.parse(s.completions)),e.sections=e.groupBy(JSON.parse(s.completions),"section"),e.stats=e.calcStats()}catch(s){console.error(s)}}))},methods:{groupBy:function(e,s){var t=[];for(var n in e)t[e[n][s]]=t[e[n][s]]||[],t[e[n][s]].push(e[n]);return t.filter((function(e){return null!==e}))},getSectionName:function(e){},setCurrent:function(e,s){this.current={id:e,section:s},this.$emit("log","dashboard_overview_item_hover",{url:this.getLink(),completion:this.getCurrent().completion})},getCurrent:function(){return this.sections[this.current.section][this.current.id]},getLink:function(e){return e=null==e?this.getCurrent():e,M.cfg.wwwroot+"/mod/"+e.type+"/view.php?id="+e.id},getStatus:function(e){return 0===(e=null==e?this.getCurrent():e).completion?'<i class="fa fa-times-square"></i>Nicht abgeschlossen':'<i class="fa fa-check"></i> Abgeschlossen'},getMilestoneResources:function(){this.milestoneResources={};for(var e=0;this.milestones.length;e++)for(j=0;j<this.milestones[e].resources.length;j++){let s=parseInt(this.milestones[e].resources[j].instance_id,10);void 0!==s&&this.milestoneResources.push(s)}},isPartOfMilestone:function(e){return-1!==this.milestoneResources.indexOf(parseInt(e,10))},trackClick:function(){let e=this.getCurrent();this.$emit("log","dashboard_overview_item_click",{type:e.type,instance:e.id})},calcStats:function(){stats=[];for(var e=0;e<this.sections.length;e++)for(var s=this.sections[e],t=0;t<s.length;t++)null==stats[s[t].section]&&(stats[s[t].section]={}),null==stats[s[t].section][s[t].type]&&(this.sectionnames[s[t].section]=s[t].sectionname,stats[s[t].section][s[t].type]={type:s[t].type,count:0,achieved_score:0,max_score:0,complete:0}),stats[s[t].section][s[t].type].count="assign"==s[t].type?parseInt(s[t].count,10):stats[s[t].section][s[t].type].count+1,stats[s[t].section][s[t].type].achieved_score+=null!=s[t].achieved_score?parseInt(s[t].achieved_score,10):0,stats[s[t].section][s[t].type].max_score+=null!=s[t].max_score?parseInt(s[t].max_score,10):0,stats[s[t].section][s[t].type].complete+=null!=s[t].submission_time?1:0;let n=[];for(t=0;t<stats.length;t++)el={sectionname:this.sectionnames[t]},stats[t].page&&(el.page={count:stats[t].page.count,complete:stats[t].page.complete}),stats[t].assign&&(el.assign={count:stats[t].assign.count,complete:stats[t].assign.complete,achieved_score:stats[t].assign.achieved_score,max_score:stats[t].assign.max_score}),stats[t].quiz&&(el.quiz={count:stats[t].quiz.count,complete:stats[t].quiz.complete,achieved_score:stats[t].quiz.achieved_score,max_score:stats[t].quiz.max_score}),n.push(el);return console.log("calccc: ",n),n},getRatio:function(e,s,t=0){if(parseInt(e)>0&&parseInt(s)>0){var n=parseInt(e)/parseInt(s)*100;return t>0&&n>t?t:n}return 0},getBarColor:function(e,s){return console.log("ratio",s),s<33?"orange":s>80?"#93ae2e":"yellow"}},template:'\n            <div id="dashboard-overview">\n                    <h3 hidden>Semesterübersicht</h3>\n                    <p class="w-75"></p>\n                    <div class="row mb-3 form-group">\n                        <div class="col-3">\n                            <label for="select-goal">Mein Ziel:</label>\n                            <select \n                                id="select-goal" \n                                class="fa-caret-down form-control w-50 form-control-sm" aria-label=".form-select-sm example" \n                                style="display:inline-block;border:none;background-color:#ddeeff;width:90px;height:18px;font-weigth:bold;">\n                                <option selected value="1">den Kurs meistern</option>\n                                <option value="2">den Kurs bestehen</option>\n                                <option value="3">einen Überblick erhalten</option>\n                            </select>\n                        </div>\n                        <div class="col-2"></div>\n                        <div class="col-4 form-group">\n                            <nav hidden class="nav nav-pills nav-sm flex-column flex-sm-row">\n                                <label for="select-timerange">Zeitraum filtern:</label>\n                                <div class="flex-sm-fill text-sm-center nav-link active">etzten 24 Stunden</div>\n                                <div class="text-sm-center nav-link">7 Tage</div>\n                                <div class="flex-sm-fill text-sm-center ">14 Tage</div>\n                                <div class="flex-sm-fill text-sm-center nav-link">letzter Monat</div>\n                                <div class="flex-sm-fill text-sm-center nav-link">Semester</div>\n                            </nav>\n                            <select hidden id="select-timerange" class="form-control w-50 form-control-sm" aria-label=".form-select-sm example"  style="margin-left:15px;display:inline-block;">\n                                <option selected>letzten 24 Stunden</option>\n                                <option value="1">letzten 7 Tage</option>\n                                <option value="2">letzten 14 Tage</option>\n                                <option value="3">letzter Monat</option>\n                                <option value="3">seit Semesterbeginn</option>\n                            </select>\n                        </div>\n                    </div>\n                    <div class="row col-8 mb-2">    \n                        <span class="col-2"><strong>Kurseinheit</strong></span>\n                        <span class="col-2"><strong>Kurstext</strong></span>\n                        <span class="col-2"><strong>Selbsttests</strong></span>\n                        <span class="col-2"><strong>Einsendeaufgaben</strong></span>\n                        <span class="col-2"><strong>Abschlussreflexion</strong></span>    \n                    </div>\n                    <div v-for="(section, sIndex) in stats" class="row col-8 mb-0">\n                        <div class="col-2 mb-1" style="border: solid #111 0pt;">\n                            \x3c!-- Course Unit --\x3e\n                            {{ section.sectionname }}\n                        </div>\n                        <div class="col-2 mb-1" style="border: solid #111 0pt;">\n                            \x3c!-- Longpage --\x3e\n                            -\n                        </div>\n                        <div class="col-2 mb-1" style="border: solid #111 0pt;">\n                            \x3c!-- Self Assessment --\x3e\n                            <span v-if="section.quiz" class="mb-1" style="display:block;position:relative;width:100px;height:15px;background-color:#eee;">\n                                <span :style="\'position:absolute;background-color:\'+getBarColor(\'quiz_completion\', getRatio(section.quiz.complete, section.quiz.count))+\';display:block;height:100%;width:\'+ getRatio(section.quiz.complete, section.quiz.count, 100) +\'%;\'">\n                                </span>\n                                <span class="p-1" style="z-index:10;position:absolute;color:#333;font-size:0.7rem;vertical-align:middle;display:block;height:100%;">\n                                    {{ section.quiz.complete }} von {{ section.quiz.count }} bearbeitet\n                                </span>\n                            </span>\n                            <span v-if="section.quiz" class="mb-1" style="display:block;position:relative;width:100px;height:15px;background-color:#eee;">\n                                <span :style="\'position:absolute;background-color:\'+getBarColor(\'quiz_score\', getRatio(section.quiz.achieved_score, section.quiz.max_score))+\';display:block;height:100%;width:\'+ getRatio(section.quiz.achieved_score, section.quiz.max_score, 100) +\'%;\'">\n                                </span>\n                                <span class="p-1" style="z-index:10;position:absolute;color:#333;font-size:0.7rem;vertical-align:middle;display:block;height:100%;">\n                                    {{ Math.round(getRatio(section.quiz.achieved_score, section.quiz.max_score), 0) }}% korrekt xxx\n                                </span>\n                            </span>\n                        </div>\n                        <div class="col-2 mb-1" style="border: solid #111 0pt; height:40px;">\n                            \x3c!-- Submission tasks --\x3e\n                            <span v-if="section.assign" class="mb-1" style="display:block;position:relative;width:100px;height:15px;background-color:#eee;">\n                                <span :style="\'position:absolute;background-color:\'+getBarColor(\'assign_completion\', getRatio(section.assign.complete, section.assign.count))+\';display:block;height:100%;width:\'+ getRatio(section.assign.complete, section.assign.count, 100) +\'%;\'">\n                                </span>\n                                <span class="p-1" style="z-index:10;position:absolute;color:#333;font-size:0.7rem;vertical-align:middle;display:block;height:100%;">\n                                    {{ section.assign.complete }} von {{ section.assign.count }} bearbeitet\n                                </span>\n                            </span>\n                            <span v-if="section.assign" class="mb-1" style="display:block;position:relative;width:100px;height:15px;background-color:#eee;">\n                                <span :style="\'position:absolute;background-color:\'+getBarColor(\'assign_score\', getRatio(section.assign.achieved_score, section.assign.max_score))+\';display:block;height:100%;width:\'+ getRatio(section.assign.achieved_score, section.assign.max_score, 100) +\'%;\'">\n                                </span>\n                                <span class="p-1" style="z-index:10;position:absolute;color:#333;font-size:0.7rem;vertical-align:middle;display:block;height:100%;">\n                                    {{ Math.round(getRatio(section.assign.achieved_score, section.assign.max_score), 0) }}% korrekt\n                                </span>\n                            </span>\n                        </div>\n                        <div class="col-2 mb-1" style="border: solid #111 0pt;">\n                           \x3c!-- Reflection task --\x3e\n                           -\n                        </div>\n                    </div>\n                    <div class="row col-8 mb-3" style="">\n                        <span class="col-2">Lernfortschritt insgesamt</span>\n                        <span class="col-2">xxx Minuten gelesen</span>\n                        <span class="col-2">xxx% erledigt<br></span>\n                        <span class="col-2">xxx% erledigt<br></span>\n                        <span class="col-2">xxx/xxx</span>  \n                    </div>\n                    <div class="right col-8 small mt-3 mr-3">\n                        Beachten Sie auch die anderen Lernmaterialien wie die <a>Virtuellen Treffen</a>, <a>Praktischen Übungen</a> und <a>Prüfungsvorbereitungen</a>\n                    </div>\n                    \n                </div>    \n            '})}));