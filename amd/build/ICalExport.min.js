define(["jquery","core/ajax"],(function(t,e){var o,n="ICalExport: Falsche Konfiguration des Kalenders",a="ICalExport: Falsche Konfiguration des Ereignisses",r="ICalExport: Falsche Konfiguration des Alarms";return function(t){t[t.DISPLAY=0]="DISPLAY",t[t.EMAIL=1]="EMAIL"}(o||(o={})),function(){function t(t,e){if(!this.valConfigData(e))throw new Error(n);this._config=e,this._ICalLib=t,this._cal=new t.Component(["vcalendar",[],[]]);var o=new t.Component("vtimezone"),a=new t.Timezone.fromData({component:o,tzid:e.tzid});o.updatePropertyWithValue("tzid",a.toString());var r=new t.Component("daylight");r.addPropertyWithValue("dtstart",new t.Time({year:1996,month:3,day:31,hour:2})),r.addPropertyWithValue("tzoffsetfrom","+01:00"),r.addPropertyWithValue("tzoffsetto","+02:00"),r.addPropertyWithValue("tzname","cest"),r.addPropertyWithValue("rrule",new t.Recur({freq:"YEARLY",bymonth:3,byday:"-1SU"})),o.addSubcomponent(r);var i=new t.Component("standard");i.addPropertyWithValue("dtstart",new t.Time({year:1996,month:10,day:27,hour:3})),i.addPropertyWithValue("tzname","cet"),i.addPropertyWithValue("tzoffsetfrom","+02:00"),i.addPropertyWithValue("tzoffsetto","+01:00"),i.addPropertyWithValue("rrule",new t.Recur({freq:"YEARLY",bymonth:10,byday:"-1SU"})),o.addSubcomponent(i),this._cal.addSubcomponent(o),this._cal.updatePropertyWithValue("prodid",e.prodid),this._cal.updatePropertyWithValue("version",e.version),this._cal.calscale=e.type.toUpperCase()}return t.prototype.print=function(){return this._cal.toString()},t.prototype.valConfigData=function(t){return"object"==typeof t&&(!("string"!=typeof t.prodid||t.prodid.length<=0)&&(!("string"!=typeof t.version||t.version.length<=0)&&(!("string"!=typeof t.type||t.type.length<=0)&&(!("string"!=typeof t.domain||t.domain.length<=0)&&!("string"!=typeof t.tzid||t.tzid.length<=0)))))},t.prototype.addEvent=function(t){if(!this.valEventData(t))throw new Error(a);var e=new this._ICalLib.Component("vevent"),o=new this._ICalLib.Event(e);return e.addPropertyWithValue("dtstamp",this._ICalLib.Time.now()),o.uid=t.uid+"@"+this._config.domain,o.startDate=this._ICalLib.Time.fromJSDate(t.start),t.end&&(o.endDate=this._ICalLib.Time.fromJSDate(t.end)),o.description=this._encode_utf8(t.description),o.summary=this._encode_utf8(t.title),t.location&&(o.location=this._encode_utf8(t.location)),this._cal.addSubcomponent(e),e},t.prototype.valEventData=function(t){return"object"==typeof t&&(("string"==typeof t.uid||"number"==typeof t.uid)&&("object"==typeof t.start&&t.start instanceof Date&&(("object"==typeof t.end||void 0===t.end)&&(("object"!=typeof t.end||t.end instanceof Date)&&("string"==typeof t.description&&("string"==typeof t.location||void 0===t.location))))))},t.prototype.addAlarm=function(t,e){if(!this.valAlarmData(e))throw new Error(r);var n=new this._ICalLib.Component("valarm");return n.addPropertyWithValue("action",o[e.type]),e.type===o.EMAIL&&void 0!==e.attendee&&("string"==typeof e.attendee?n.addPropertyWithValue("attendee","MAILTO:"+e.attendee):e.attendee.forEach((function(t){n.addPropertyWithValue("attendee","MAILTO:"+t)}))),n.addPropertyWithValue("dtstamp",this._ICalLib.Time.now()),n.addPropertyWithValue("trigger",this._ICalLib.Time.fromJSDate(e.date)),e.title&&n.addPropertyWithValue("summary",this._encode_utf8(e.title)),n.addPropertyWithValue("description",this._encode_utf8(e.description)),t.addSubcomponent(n),n},t.prototype.valAlarmData=function(t){return"object"==typeof t&&("number"==typeof t.type&&((t.type!==o.EMAIL||"string"==typeof t.attendee||"object"==typeof t.attendee)&&(t.date instanceof Date&&("string"==typeof t.description&&("string"==typeof t.title||void 0===t.title)))))},t.prototype._encode_utf8=function(t){return unescape(encodeURIComponent(t.replace(/  +/g,"")))},t}()}));