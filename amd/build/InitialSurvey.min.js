/**
 * InitialSurvey
 *
 * @module     format/ladtopics
 * @package    format_ladtopics
 * @class      InitialSurvey
 * @copyright  2019 Niels Seidel, niels.seidel@fernuni-hagen.de
 * @license    MIT
 * @since      3.1
 */
define(["jquery",M.cfg.wwwroot+"/course/format/ladtopics/lib/build/vue.min.js",M.cfg.wwwroot+"/course/format/ladtopics/lib/build/Sortable.min.js"],(function(e,i,t){return function(s,a,n){var r=parseInt(e("#courseid").text(),10),o={biwi:{}};o.biwi.exame=[],o.biwi.orientation=[],o.cs={},o.cs.exame=[],o.cs.orientation=[],new i({el:"#planningsurvey",data:function(){return{modalSurveyVisible:!1,surveyComplete:!1,objectives:"",availableTime:0,planingStyle:"",selectedMonth:-1,selectedYear:-1,resources:[],availableResources:[],invalidAvailableTime:!1,invalidAvailableTimeNotEnough:!1,invalidObjective:!1,invalidResources:!1,invalidPlaningStyle:!1}},mounted:function(){var i=this;a.get_ws("coursestructure",{courseid:parseInt(n.id,10),select:{modules:JSON.stringify(["assign","data","hvp","checklist","url","studentquiz","page","feedback","forum","resource","glossary","quiz","wiki"])}},(function(e){try{var t=JSON.parse(e.data),s=new Array(t.length);for(var a in t){var n=0;for(var r in t)t[a]!==t[r]&&(+t[r].pos_section<+t[a].pos_section||+t[r].pos_module<+t[a].pos_module)&&n++;for(;"object"==typeof s[n];)n++;s[n]=t[a]}i.availableResources=s}catch(e){console.error(e)}})),a.get_ws("userpreferences",{data:{setget:"get",fieldname:"ladtopics_survey_done",courseid:parseInt(n.id,10)}},(function(t){try{(t=JSON.parse(t.response))[0]&&parseInt(t[0].value,10)&&(i.surveyComplete=parseInt(t[0].value,10)>0,s.surveyDone=parseInt(t[0].value,10)),s.surveyDone>0?e("#planing-component").show():e("#planningsurvey").show()}catch(t){console.error("Could not fetch user_preferences: ",t)}}))},created:function(){this.showModal()},methods:{showModal:function(e){this.modalSurveyVisible=!0},closeModal:function(e){this.modalSurveyVisible=!1},monthRange:function(){return a.monthRange},yearRange:function(){return[2021,2022,2023,2024]},monthSelected:function(e){this.selectedMonth=e.target.value},yearSelected:function(e){this.selectedYear=e.target.value},resourcesBySection:function(e){return this.availableResources.filter((function(i){return parseInt(i.section_id,10)===parseInt(e,10)}))},resourceSections:function(){for(var e={},i=0;i<this.availableResources.length;i++)e[this.availableResources[i].section_id]={name:" "===this.availableResources[i].section_name?"(Einführung)":this.availableResources[i].section_name,id:this.availableResources[i].section_id};return e},resourceById:function(e){return this.availableResources.filter((function(i){return parseInt(i.id,10)===parseInt(e,10)}))[0]},resourceSelected:function(e){var i=-1;i=e.target.value.match(/complete-section-\d/i)?-99:this.resourceById(e.target.value),this.resources.push(i);var s=document.getElementById("selected_resources");t.create(s,{});this.invalidResources=!(this.resources.length>0)},resourceRemove:function(e){for(var i=0;i<this.resources.length;i++)this.resources[i].id===e&&this.resources.splice(i,1);this.invalidResources=!(this.resources.length>0)},updateObjective:function(e){console.log("update ",this.objectives),this.invalidObjective=""===this.objectives},updateAvailableTime:function(){this.invalidAvailableTime=this.availableTime<=0,this.invalidAvailableTimeNotEnough=this.availableTime<=n.minimumWeeklyWorkload},updatePlaningStyle:function(e){this.invalidPlaningStyle=""===this.planingStyle},validateSurveyForm:function(){var e=!0;""===this.objectives&&(this.invalidObjective=!0,e=!1),this.availableTime<=0&&(this.invalidAvailableTime=!0,e=!1),""===this.planingStyle&&(this.invalidPlaningStyle=!0,e=!1),"f1c"===this.objectives&&0===this.resources.length&&this.availableResources.length>0&&(this.invalidResources=!0,e=!1),e&&this.saveSurvey()},isAvailableTimeSufficient:function(){return this.availableTime<=0?"":"f1a"===this.objectives&&1==+this.availableTime?"Eine Stunde pro Woche ist zu wenig Zeit, um sich auf die Prüfung vorzubereiten. Der Arbeitsaufwand für ein Modul beträgt 19h pro Woche.":"f1a"===this.objectives&&this.availableTime>1&&this.availableTime<=n.minimumWeeklyWorkload?this.availableTime+" Stunden pro Woche sind zu wenig Zeit, um sich auf die Prüfung vorzubereiten. Der Arbeitsaufwand für ein Modul beträgt 19h pro Woche.":"f1a"!==this.objectives&&1===this.availableTime?"Eine Stunde pro Woche ist zu wenig Zeit, um das Modul in einem Semester durchzuarbeiten. Der Arbeitsaufwand für ein Modul beträgt 19h pro Woche.":"f1a"!==this.objectives&&this.availableTime>1&&this.availableTime<=n.minimumWeeklyWorkload?this.availableTime+" Stunden pro Woche sind zu wenig Zeit, um das Modul in einem Semester durchzuarbeiten. Der Arbeitsaufwand für ein Modul beträgt 19h pro Woche.":this.availableTime>=n.maximumWeeklyWorkload?"Wollen Sie wirklich "+this.availableTime+" Stunden pro Woche aufwenden? Normalerweise benötigt man ca. 20 h/Woche für eine gute Vorbereitung.":void 0},buttonText:function(){var e="Fortfahren";return""===this.objectives&&""===this.planingStyle||(e={f1a:"Semesterplanung für die Prüfungsvorbereitung vorschlagen",f1b:"Semesterplanung für eine erste Orientierung vorschlagen",f1c:"",f1d:""}[this.objectives]),e},saveSurvey:function(){switch(this.modalSurveyVisible=!1,this.objectives){case"f1a":2===r&&o.biwi.exame.length>0?s.addMilestones(o.biwi.exame):3===r&&o.cs.exame.length>0&&s.addMilestones(o.cs.exame);break;case"f1b":2===r&&o.biwi.orientation.length>0?s.addMilestones(o.biwi.orientation):3===r&&o.cs.orientation.length>0&&s.addMilestones(o.cs.orientation)}var i=this;a.get_ws("userpreferences",{data:{setget:"set",courseid:parseInt(n.id,10),fieldname:"ladtopics_survey_done",value:1}},(function(t){try{t=JSON.parse(t.response),s.surveyDone=1,this.surveyComplete=!0,e("#theSurveyModal").modal("hide"),e("#planing-component").show(),e(".survey-btn").hide(),a.get_ws("userpreferences",{data:{setget:"set",courseid:parseInt(n.id,10),fieldname:"ladtopics_survey_results",value:JSON.stringify({objectives:i.objectives,availableTime:i.availableTime,planingStyle:i.planingStyle,selectedMonth:i.selectedMonth,selectedYear:i.selectedYear,resources:i.resources})}},(function(e){}))}catch(t){console.error("Could not fetch user_preferences: ",t)}}))}}})}}));