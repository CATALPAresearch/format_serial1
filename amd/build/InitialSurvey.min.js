/**
 * InitialSurvey
 *
 * @module     format/ladtopics
 * @package    format_ladtopics
 * @class      InitialSurvey
 * @copyright  2019 Niels Seidel, niels.seidel@fernuni-hagen.de
 * @license    MIT
 * @since      3.1
 */
define(["jquery",M.cfg.wwwroot+"/course/format/ladtopics/lib/build/vue.min.js",M.cfg.wwwroot+"/course/format/ladtopics/lib/build/Sortable.min.js"],(function(e,i,n){return function(a,l,t){var s=parseInt(e("#courseid").text(),10),o={biwi:{}};o.biwi.exame=[],o.biwi.orientation=[],o.cs={},o.cs.exame=[],o.cs.orientation=[],new i({el:"initial-survey",data:function(){return{modalSurveyVisible:!1,surveyComplete:!1,objectives:"",availableTime:0,planingStyle:"",selectedMonth:-1,selectedYear:-1,resources:[],availableResources:[],invalidAvailableTime:!1,invalidAvailableTimeNotEnough:!1,invalidObjective:!1,invalidResources:!1,invalidPlaningStyle:!1}},mounted:function(){var i=this;l.get_ws("coursestructure",{courseid:parseInt(t.id,10),select:{modules:JSON.stringify(["assign","data","hvp","checklist","url","studentquiz","page","feedback","forum","resource","glossary","quiz","wiki"])}},(function(e){try{var n=JSON.parse(e.data),a=new Array(n.length);for(var l in n){var t=0;for(var s in n)n[l]!==n[s]&&(+n[s].pos_section<+n[l].pos_section||+n[s].pos_module<+n[l].pos_module)&&t++;for(;"object"==typeof a[t];)t++;a[t]=n[l]}i.availableResources=a}catch(e){console.error(e)}})),l.get_ws("userpreferences",{data:{setget:"get",fieldname:"ladtopics_survey_done",courseid:parseInt(t.id,10)}},(function(n){try{(n=JSON.parse(n.response))[0]&&parseInt(n[0].value,10)&&(i.surveyComplete=parseInt(n[0].value,10)>0,a.surveyDone=parseInt(n[0].value,10)),a.surveyDone>0?e("#planing-component").show():e("#planningsurvey").show()}catch(n){console.error("Could not fetch user_preferences: ",n)}}))},created:function(){this.showModal()},methods:{showModal:function(e){this.modalSurveyVisible=!0},closeModal:function(e){this.modalSurveyVisible=!1},monthRange:function(){return l.monthRange},yearRange:function(){return[2021,2022,2023,2024]},monthSelected:function(e){this.selectedMonth=e.target.value},yearSelected:function(e){this.selectedYear=e.target.value},resourcesBySection:function(e){return this.availableResources.filter((function(i){return parseInt(i.section_id,10)===parseInt(e,10)}))},resourceSections:function(){for(var e={},i=0;i<this.availableResources.length;i++)e[this.availableResources[i].section_id]={name:" "===this.availableResources[i].section_name?"(Einführung)":this.availableResources[i].section_name,id:this.availableResources[i].section_id};return e},resourceById:function(e){return this.availableResources.filter((function(i){return parseInt(i.id,10)===parseInt(e,10)}))[0]},resourceSelected:function(e){var i=-1;i=e.target.value.match(/complete-section-\d/i)?-99:this.resourceById(e.target.value),this.resources.push(i);var a=document.getElementById("selected_resources");n.create(a,{});this.invalidResources=!(this.resources.length>0)},resourceRemove:function(e){for(var i=0;i<this.resources.length;i++)this.resources[i].id===e&&this.resources.splice(i,1);this.invalidResources=!(this.resources.length>0)},updateObjective:function(e){console.log("update ",this.objectives),this.invalidObjective=""===this.objectives},updateAvailableTime:function(){this.invalidAvailableTime=this.availableTime<=0,this.invalidAvailableTimeNotEnough=this.availableTime<=t.minimumWeeklyWorkload},updatePlaningStyle:function(e){this.invalidPlaningStyle=""===this.planingStyle},validateSurveyForm:function(){var e=!0;""===this.objectives&&(this.invalidObjective=!0,e=!1),this.availableTime<=0&&(this.invalidAvailableTime=!0,e=!1),""===this.planingStyle&&(this.invalidPlaningStyle=!0,e=!1),"f1c"===this.objectives&&0===this.resources.length&&this.availableResources.length>0&&(this.invalidResources=!0,e=!1),e&&this.saveSurvey()},isAvailableTimeSufficient:function(){return this.availableTime<=0?"":"f1a"===this.objectives&&1==+this.availableTime?"Eine Stunde pro Woche ist zu wenig Zeit, um sich auf die Prüfung vorzubereiten. Der Arbeitsaufwand für ein Modul beträgt 19h pro Woche.":"f1a"===this.objectives&&this.availableTime>1&&this.availableTime<=t.minimumWeeklyWorkload?this.availableTime+" Stunden pro Woche sind zu wenig Zeit, um sich auf die Prüfung vorzubereiten. Der Arbeitsaufwand für ein Modul beträgt 19h pro Woche.":"f1a"!==this.objectives&&1===this.availableTime?"Eine Stunde pro Woche ist zu wenig Zeit, um das Modul in einem Semester durchzuarbeiten. Der Arbeitsaufwand für ein Modul beträgt 19h pro Woche.":"f1a"!==this.objectives&&this.availableTime>1&&this.availableTime<=t.minimumWeeklyWorkload?this.availableTime+" Stunden pro Woche sind zu wenig Zeit, um das Modul in einem Semester durchzuarbeiten. Der Arbeitsaufwand für ein Modul beträgt 19h pro Woche.":this.availableTime>=t.maximumWeeklyWorkload?"Wollen Sie wirklich "+this.availableTime+" Stunden pro Woche aufwenden? Normalerweise benötigt man ca. 20 h/Woche für eine gute Vorbereitung.":void 0},buttonText:function(){var e="Fortfahren";return""===this.objectives&&""===this.planingStyle||(e={f1a:"Semesterplanung für die Prüfungsvorbereitung vorschlagen",f1b:"Semesterplanung für eine erste Orientierung vorschlagen",f1c:"Fortfahren",f1d:"Fortfahren"}[this.objectives]),e},saveSurvey:function(){switch(this.objectives){case"f1a":2===s&&o.biwi.exame.length>0?a.addMilestones(o.biwi.exame):3===s&&o.cs.exame.length>0&&a.addMilestones(o.cs.exame);break;case"f1b":2===s&&o.biwi.orientation.length>0?a.addMilestones(o.biwi.orientation):3===s&&o.cs.orientation.length>0&&a.addMilestones(o.cs.orientation)}var i=this;l.get_ws("userpreferences",{data:{setget:"set",courseid:parseInt(t.id,10),fieldname:"ladtopics_survey_done",value:1}},(function(n){try{n=JSON.parse(n.response),a.surveyDone=1,this.surveyComplete=!0,e("#theSurveyModal").modal("hide"),e("#planing-component").show(),e(".survey-btn").hide(),l.get_ws("userpreferences",{data:{setget:"set",courseid:parseInt(t.id,10),fieldname:"ladtopics_survey_results",value:JSON.stringify({objectives:i.objectives,availableTime:i.availableTime,planingStyle:i.planingStyle,selectedMonth:i.selectedMonth,selectedYear:i.selectedYear,resources:i.resources})}},(function(e){location.reload()}))}catch(n){console.error("Could not fetch user_preferences: ",n)}}))}},template:'\n                <div id="planningsurvey" display="visibility: hidden;">\n                    <div v-if="!surveyComplete" hidden class="row survey-btn">\n                        <div class="col-sm-2 col-centered">\n                            <div class="wrapper">\n                                <div @click="showModal()" class="survey-starter survey-animate" data-toggle="modal" data-target="#theSurveyModal">\n                                    <span>Lernen mit Plan</span>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    <div id="theSurveyModal" class="xmodal" tabindex="-1" role="dialog">\n                        <div v-if="modalSurveyVisible" class="xmodal-dialog xmodal-lg" role="document">\n                            <div class="modal-content">\n                                <div class="modal-header">\n                                    <h5 class="modal-title" id="MilestoneModalLabel">Vorbereitung Ihrer Semesterplanung für diesen Kurs</h5>\n                                    <button @click="closeModal()" type="button" class="close" data-dismiss="modal"\n                                        aria-label="Close">\n                                        <span aria-hidden="true">&times;</span>\n                                    </button>\n                                </div>\n                                <div class="modal-body">\n                                    <div class="form-check row">\n                                        <p>Teilen Sie uns bitte hier Ihre Ziele mit, dann können wir Sie in der Semesterplanung besser unterstützen.\n                                        </p>\n                                        <label for="" class="col-12 col-form-label survey-objective-label">Welches Ziel verfolgen\n                                            Sie in diesem Kurs/Modul?</label>\n                                        <span :style="invalidObjective ? \'display:inline-block; border: solid 1px #ff420e;\' : \'\'">\n                                            <div class="form-check">\n                                                <input @change="updateObjective" class="form-check-input" type="radio" name="exampleRadios" id="exampleRadios1"\n                                                    value="f1a" v-model="objectives">\n                                                <label class="form-check-label" for="exampleRadios1">\n                                                    Die Prüfung erfolgreich absolvieren\n                                                </label>\n                                            </div>\n                                            <div class="form-check">\n                                                <input @change="updateObjective" class="form-check-input" type="radio" name="exampleRadios" id="exampleRadios2"\n                                                    value="f1b" v-model="objectives">\n                                                <label class="form-check-label" for="exampleRadios2">\n                                                    Orientierung im Themengebiet erlangen\n                                                </label>\n                                            </div>\n                                            <div class="form-check">\n                                                <input @change="updateObjective" class="form-check-input" type="radio" name="exampleRadios" id="exampleRadios3"\n                                                    value="f1c" v-model="objectives">\n                                                <label class="form-check-label" for="exampleRadios3">\n                                                    Meinen eigenen Interessen bzgl. bestimmter Themengebiete nachgehen\n                                                </label>\n                                            </div>\n                                            \n                                            <div class="form-check">\n                                                <input @change="updateObjective" class="form-check-input" type="radio" name="exampleRadios" id="exampleRadios4"\n                                                    value="f1d" v-model="objectives">\n                                                <label class="form-check-label" for="exampleRadios4">\n                                                    keine Angaben\n                                                </label>\n                                            </div>\n                                        </span>\n                                        <div class="col-12 alert-invalid" role="alert" v-if="invalidObjective">Entscheiden Sie sich bitte für einer der Auswahlmöglichkeiten</div>\n                                    </div>\n                                    <hr>\n                                    <div class="form-check row">\n                                        <label for="inputMSname" class="col-10 col-form-label survey-objective-label">Wie viele Stunden pro Woche planen Sie für das Lernen in diesem Kurs / Modul ein?</label>\n                                        <div class="col-2 ml-0 pl-0">\n                                            <input :style="invalidAvailableTime ? \'border: solid 1px #ff420e;\' : \'\'" type="number" @change="updateAvailableTime()" class="form-control ml-0" id="inputMSname" placeholder="0" min="0"\n                                                v-model="availableTime">\n                                        </div>\n                                        <div class="col-12 alert-invalid" role="alert" v-if="invalidAvailableTime">Geben Sie bitte eine Anzahl an Stunden, die größer Null ist.</div>\n                                        <div class="col-12 w-50 alert-warning" role="warning">{{ isAvailableTimeSufficient() }}</div>\n                                    </div>\n                                    <hr>\n                                    <div class="form-check row">\n                                        <label for="" class="col-12 col-form-label survey-objective-label">\n                                            Wie detailliert planen Sie Ihre Lernaktivitäten?<br/>Ich plane meist \n                                        </label>\n                                        <span :style="invalidPlaningStyle ? \'display:inline-block; border: solid 1px #ff420e;\' : \'\'">\n                                            <div class="form-check">\n                                                <input @change="updatePlaningStyle" class="form-check-input" type="radio" name="planingRadios" id="planingRadios1"\n                                                    value="planing-style-a" v-model="planingStyle">\n                                                <label class="form-check-label" for="planingRadios1">\n                                                    nur für eine Woche.\n                                                </label>\n                                            </div>\n                                            <div class="form-check">\n                                                <input @change="updatePlaningStyle" class="form-check-input" type="radio" name="planingRadios" id="planingRadios2"\n                                                    value="planing-style-b" v-model="planingStyle">\n                                                <label class="form-check-label" for="planingRadios2">\n                                                    für die nächsten 4 Wochen.\n                                                </label>\n                                            </div>\n                                            <div class="form-check">\n                                                <input @change="updatePlaningStyle" class="form-check-input" type="radio" name="planingRadios" id="planingRadios3"\n                                                    value="planing-style-c" v-model="planingStyle">\n                                                <label class="form-check-label" for="planingRadios3">\n                                                    für das ganze Semester mit Arbeitspaketen für je eine Woche.\n                                                </label>\n                                            </div>\n                                                <div class="form-check">\n                                                <input @change="updatePlaningStyle" class="form-check-input" type="radio" name="planingRadios" id="planingRadios4"\n                                                    value="planing-style-d" v-model="planingStyle">\n                                                <label class="form-check-label" for="planingRadios4">\n                                                    für das ganze Semester mit Arbeitspaketen für je 2 Wochen. \n                                                </label>\n                                            </div>\n                                                <div class="form-check">\n                                                <input @change="updatePlaningStyle" class="form-check-input" type="radio" name="planingRadios" id="planingRadios5"\n                                                    value="planing-style-e" v-model="planingStyle">\n                                                <label class="form-check-label" for="planingRadios5">\n                                                    für das ganze Semester mit Arbeitspaketen für je einen Monat.\n                                                </label>\n                                            </div>\n                                            <div class="form-check">\n                                                <input @change="updatePlaningStyle" class="form-check-input" type="radio" name="planingRadios" id="planingRadios6"\n                                                    value="planing-style-f" v-model="planingStyle">\n                                                <label class="form-check-label" for="planingRadios6">\n                                                    keine Angaben\n                                                </label>\n                                            </div>\n                                        </span>\n                                        <div class="col-12 alert-invalid" role="alert" v-if="invalidPlaningStyle">Verraten Sie uns bitte wie detailliert Sie Ihre Lernaktivitäten planen.</div>\n                                    </div>\n                                    <hr v-if="objectives === \'f1a\'">\n                                    <div v-if="objectives === \'f1a\'" class="form-check row">\n                                        <label for="inputObjectic" class="col-10 col-form-label survey-objective-label">Wann beabsichtigen Sie die Prüfung\n                                            abzulegen?</label>\n                                        <div class="col-4">\n                                            <select @change="monthSelected" id="select_month">\n                                                \x3c!-- \n                                                :selected="selectedMonth === -1 ? (d.num-1 === (new Date()).getMonth()) : ((d.num-1)===selectedMonth)"\n                                                --\x3e\n                                                <option v-for="d in monthRange()"\n                                                    :value="d.num">{{ d.name }}</option>\n                                            </select>\n\n                                            <select @change="yearSelected" id="select_year">\n                                                \x3c!--\n                                                :selected="selectedYear === -1 ? (d === (new Date()).getFullYear()) : d===selectedYear"\n                                                --\x3e\n                                                <option v-for="d in yearRange(3)" >\n                                                    {{ d }}\n                                                </option>\n                                            </select>\n                                        </div>\n                                        <div class="col-7"></div>\n                                    </div>\n                                    \n                                    \n                                    <br />\n                                    <div class="row row-smooth">\n                                        <div class="col-md">\n                                            <div>\n                                                <button @click="validateSurveyForm()" class="btn btn-primary btn-sm">{{ buttonText() }}</button>\n                                                <button class="right btn btn-link right" @click="closeModal()" data-dismiss="modal"\n                                                    aria-label="abbrechen">jetzt nicht</button>\n                                            </div>\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            '})}}));