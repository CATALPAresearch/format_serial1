/**
 * Timeline
 *
 * @module     format/ladtopics
 * @class      Timeline
 * @copyright  2020 Marc Burchart, Niels Seidel <niels.seidel@fernuni-hagen.de>
 * @license    MIT
 * @since      3.1
 */
define([M.cfg.wwwroot+"/course/format/ladtopics/lib/build/vue.min.js",M.cfg.wwwroot+"/course/format/ladtopics/amd/build/ICalExport.min.js",M.cfg.wwwroot+"/course/format/ladtopics/amd/build/ErrorHandler.min.js"],(function(e,t,r){return require.config({enforceDefine:!1,paths:{ICAL:[M.cfg.wwwroot+"/course/format/ladtopics/lib/build/ical.min"]},shim:{ICAL:{exports:"ICAL"}}}),e.component("MilestoneCalendarExport",{props:["milestones","calendar"],template:'<div class = "milestone-calendar-export"><a class="dropdown-item" @click="exportToICal()" href="#"><i class="fa fa-clock mr-1"></i>Termine in Kalender (iCal) exportieren</a></div>',methods:{exportToICal:function(){var e=this;try{require(["ICAL"],(function(i){let a=new t(i,{prodid:"APLE",domain:"APLE",tzid:"Europe/Berlin",type:"Gregorian",version:"2.0"});e.milestones&&e.milestones.length>0&&e.milestones.forEach(e=>{try{let t=new Date(e.end.toISOString());t.setHours(12),t.setMinutes(0),t.setSeconds(0);let r={uid:e.id,title:"[Meilenstein] "+e.name,start:t},i=e.objective?"Lernziel: "+e.objective:"";e.resources&&e.resources.length>0&&(i+="\n\nZu diesem Meilenstein gehören folgende Lernressourcen:",e.resources.forEach(e=>{let t=e.checked?"[erledigt] ":"";e.instance_title&&(i+="\n- "+t+e.instance_title)})),e.strategies&&e.strategies.length>0&&(i+="\n\nZu diesem Meilenstein gehören folgende Lernstrategien:",e.strategies.forEach(e=>{let t=e.checked?"[erledigt] ":"";e.name&&(i+="\n- "+t+e.name)})),r.description=i;let n=a.addEvent(r),s=new Date(e.start.toISOString());s.setDate(s.getDate()-3),console.log(r),a.addAlarm(n,{type:0,title:r.title,date:s,description:"Der Meilenstein "+r.title+" ist fast erreicht!"}),s.setDate(s.getDate()-4),a.addAlarm(n,{type:0,title:r.title,date:s,description:"Der Meilenstein "+r.title+" ist bald erreicht!"}),console.log(a.print())}catch(e){new r(e)}}),"object"==typeof e.calendar&&Object.keys(e.calendar).length>0&&Object.keys(e.calendar).forEach(t=>{try{let r=e.calendar[t],i="[Nutzertermin]";switch(r.eventtype){case"course":i="[Kurstermin]";break;case"category":i="[Kursbereich]";break;case"site":i="[Seitentermin]";break;case"group":i="[Gruppentermin]"}let n={uid:t+r.timemodified,title:i+" "+r.name,start:new Date(1e3*r.timestart)};r.timeduration&&(n.stop=new Date(1e3*r.timestart+1e3*r.timeduration)),n.description=r.description;let s=a.addEvent(n),o=new Date(n.start.toISOString());o.setDate(o.getDate()-3),a.addAlarm(s,{type:0,title:n.title,date:o,description:"Der Termin "+n.title+" ist fast erreicht!"}),o.setDate(o.getDate()-4),a.addAlarm(s,{type:0,title:n.title,date:o,description:"Der Termin "+n.title+" ist bald erreicht!"})}catch(e){new r(e)}});let n=new Date,s=n.getFullYear().toString().padStart(4,"0"),o=n.getMonth()+1;o=o.toString().padStart(2,"0");let l=n.getDate().toString().padStart(2,"0"),c=n.getHours().toString().padStart(2,"0"),d=n.getMinutes().toString().padStart(2,"0"),m=document.title.replace(/[^A-Za-z0-9]/g,"");var p=document.createElement("a");p.href="data:text/calendar;charset=utf-8,"+escape(a.print()),p.download="Semesterplanung_"+m+"_"+s+o+l+c+d+".ics",p.click()}))}catch(e){new r(e)}}}})}));