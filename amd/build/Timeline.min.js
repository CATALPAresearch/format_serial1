/**
 * Timeline
 *
 * @module     format/ladtopics
 * @package    format_ladtopics
 * @class      Timeline
 * @copyright  2019 Niels Seidel, niels.seidel@fernuni-hagen.de
 * @license    MIT
 * @since      3.1
 */
define(["jquery","core/ajax",M.cfg.wwwroot+"/course/format/ladtopics/lib/build/vue.min.js",M.cfg.wwwroot+"/course/format/ladtopics/amd/src/MilestoneCalendarExport.js",M.cfg.wwwroot+"/course/format/ladtopics/amd/src/DashboardCompletion.js"],(function(e,t,s,i,n){console.log(s);return function(t,a,r,o,l,d,c,u,h,m,g,f,p){e(document).ready((function(){let t=e("a.milestone-element-edit"),s=e("span.ms-edit-filler");s.innerWidth(t.innerWidth()),s.css("display","inline-block")}));var S=document.getElementById("ladtopic-container-0").offsetWidth,y={top:15,right:10,bottom:20,left:10},v={courseType:"Kurs",semesterShortName:"SoSe 2020",id:parseInt(e("#courseid").text(),10),startDate:new Date(2020,3,1,0,0,0),endDate:new Date(2020,8,30,23,59,59),start:new Date(2020,3,1,0,0,0).getTime()/1e3,end:new Date(2020,8,30,23,59,59).getTime()/1e3,minimumWeeklyWorkload:6,maximumWeeklyWorkload:30,maxPlaningPeriod:12};l.get_ws("logstore",{courseid:parseInt(v.id,10)},(function(e){try{b(JSON.parse(e.data),c)}catch(e){console.error(e)}}));var b=function(c,m){var b=[v.startDate,v.endDate],w=new s({el:"#planing-component",components:{datepicker:g,"milestone-calendar-export":i,"dashboard-completion":n},data:function(){return{startDate:new Date,endDate:new Date,semesterRange:null,dpRange:null,daysOffset:20,DPde:f,course:v,surveyDone:0,chart:"",timeFilterChart:"",xAxis:"",yAxis:"",x_axis_call:"",y_axis_call:"",colors:["#98abc5","#8a89a6","#7b6888","#6b486b","#a05d56","#d0743c","#ff8c00"],bars:"",barwidth:80,barheight:21,bardist:3,maxLanes:3,width:730,height:70,margins:{},padding:100,xmin:0,xmax:0,ymin:0,ymax:3,done:[],range:[],milestones:[],calendar:{},emptyMilestone:{id:10,name:"",objective:"",start:"",end:"",status:"progress",progress:0,resources:[],strategies:[],reflections:[],yLane:0,mod:!1},invalidName:!1,invalidObjective:!1,invalidResources:!1,invalidStrategy:!1,invalidEndDate:!1,invalidStartDate:!1,invalidReflections:[],selectedDay:1,selectedMonth:1,selectedYear:v.startDate.getFullYear(),invalidDay:!1,selectedStartDay:1,selectedStartMonth:1,selectedStartYear:v.startDate.getFullYear(),invalidEndDay:!1,invalidStartDay:!1,filterPreset:"",selectedMilestone:0,modalVisible:!1,modalReflectionVisible:!1,reflectionsFormVisisble:!1,modUsers:[],modStatistics:{users:0,surveys:0,milestones:0,msProgessed:0,msReady:0,msUrgent:0,msMissed:0,msReflected:0,ptExam:0,ptOrientation:0,ptInterest:0,ptNoAnswer:0,ptW1:0,ptW4:0,ptWA:0,ptWA2:0,ptWA4:0,ptWANA:0},strategyCategories:[{id:"organization",name:"Organisation"},{id:"elaboration",name:"Elaborationsstrategien"},{id:"repeatition",name:"Wiederholungsstrategien"},{id:"misc",name:"Sonstige"}],strategies:[{id:"reading",name:"Überblick durch Lesen/Querlesen",desc:'<div>Durch schnelles Querlesen verschaffen Sie sich einen Überblick über das Themengebiet. Schauen Sie sich doch auch einmal die PQ4R-Methode an. <a href="https://www.example.com/">Details</a></div>',url:"",category:"organization"},{id:"mindmap",name:"Erzeuge Mindmap",desc:"Eine Mindmap hilft dabei, Zusammenhänge darzustellen.",url:"",category:"organization"},{id:"exzerpte",name:"Fertige Exzerpt an",desc:"Ein Exzerpt ist mehr als nur eine einfache Zusammenfassung der wichtigsten Inhalte.",url:"",category:"organization"},{id:"gliederung",name:"Erstelle Gliederung",desc:"Themenfelder lassen sich mit einer Gliederung übersichtlich strukturieren.",url:"",category:"organization"},{id:"strukturierung",name:"Strukturiere Wissen",desc:"Fachausdrücke oder Definitionen lassen sich gut in Listen oder Tabellen sammeln.",url:"",category:"organization"},{id:"makeflashcards",name:"Lernkarten erstellen",desc:"Lernkarten kann man sehr früh digital z.B. in einer App oder auf Papier erstellen. Das erleichtert die Prüfungsvorbereitung.",url:"",category:"organization"},{id:"transfer",name:"Wende neues Wissen an",desc:"Neues Wissen kann durch die Verknüpfung mit dem eigenen Erleben leichter veranschaulicht und gelernt werden.",url:"",category:"elaboration"},{id:"examples",name:"Übertrage Ansätze auf Berufliches",desc:"Ein Beispiel aus dem eigenen Umfeld hilft dabei, neue Wissensschemata schneller zu lernen.",url:"",category:"elaboration"},{id:"critical",name:"Hinterfrage Inhalte kritisch",desc:"Durch kritisches Hinterfragen kann man seine Aufmerksamkeit beim Lesen steigern.",url:"",category:"elaboration"},{id:"structuring",name:"Stelle Bezug zu anderen Fächern her",desc:"Bekanntes Wissen und Bezüge zu anderen Kursen erleichtern das Verständnis von Zusammenhängen.",url:"",category:"elaboration"},{id:"pq4r",name:"Wende PQ4R - Methode an",desc:"Hinter dem Kürzel verstecken sich sechs Schritte: (1) Preview – Übersicht gewinnen; (2) Questions – Fragen an den Text stellen;  (3) Read – Zweiter Leseschritt - Gründliches Lesen des Textes; (4) Reflect – Gedankliche Auseinandersetzung mit dem Text; (5) Recite – Wiederholen und aus dem Gedächtnis Verfassen; (6) Review – Rückblick und Überprüfung",url:"",category:"elaboration"},{id:"flashcards",name:"Auswendiglernen mit Lernkarten",desc:"Mit Lernkarten kann man Dinge systematisch wiederholen bis alles für die Prüfung sitzt. ",url:"",category:"repeatition"},{id:"repeatition",name:"Repetieren",desc:"Mit vielen Wiederholungen festigt sich das Wissen. ",url:"",category:"repeatition"},{id:"assoc",name:"Eselsbrücken",desc:"Mit einem Reim oder einer Eselsbrücke kann man sich Begriffe oder Reihenfolgen leichter merken.",url:"",category:"repeatition"},{id:"loci",name:"Loci Methode",desc:"Bei der Loci Methode verknüpft man Lerninhalte mit Orten oder Gegenständen. Für Abfolgen übt man eine Strecke/einen Spaziergang ein.",url:"",category:"repeatition"}],resources:[]}},mounted:function(){o.locale("de");var s=this;this.range=b,l.get_ws("getmilestones",{data:{courseid:parseInt(v.id,10)}},(function(e){s.emptyMilestone.end=new Date,s.emptyMilestone.start=new Date,s.initializeChart();try{if(null!==e){var i=JSON.parse(e.milestones);if(i&&i.milestones){s.milestones=JSON.parse(i.milestones),s.updateMilestoneStatus();var n=r(c);s.timeFilterChart=new u(t,a,r,n,b,s,l,m,v),s.setFilterPreset("last-month");var d=new h(t,a,r,o,c,l,v);b=d.getXRange(),s.timeFilterChart.registerChart(d),m.add("planing_tool_open",{pageLoaded:!0})}else s.milestones=[]}}catch(e){s.milestones=[]}})),this.getMilestonePlan(),l.get_ws("getcalendar",{courseid:parseInt(v.id,10)},(function(e){try{"string"==typeof e.data&&e.data.length>0&&(s.calendar=JSON.parse(e.data))}catch(e){new p(e)}})),e(document).ready((function(){e("#reportModal").length>0&&e("#reportModal").on("shown.bs.modal",(function(){s.modGetStatisticData(s)}))}))},created:function(){var t=this;e(document).keyup((function(e){e.preventDefault(),"Escape"===e.key&&(t.updateMilestoneStatus(),t.updateChart(t.range))})),e("#additionalCharts").hide(),e("#filter-presets").hide(),this.dpRange={to:v.startDate,from:o(v.endDate).add(v.maxPlaningPeriod,"months").toDate()}},watch:{milestones:function(e){},surveyDone:function(t){this.surveyDone>0&&(e(".activity-chart-container").show(),e(".filter-chart-container").show())}},computed:{archivedMilestones:function(){return this.milestones.filter((function(e){return"missed"===e.status||"reflected"===e.status}))},remainingMilestones:function(){return this.milestones.filter((function(e){return"missed"!==e.status&&"reflected"!==e.status}))},dayOfSelectedMilestone:{get:function(){return this.getSelectedMilestone().end.getDate()},set:function(e){}},monthOfSelectedMilestone:{get:function(){return this.getSelectedMilestone().end.getMonth()+1},set:function(e){}},yearOfSelectedMilestone:{get:function(){return this.getSelectedMilestone().end.getFullYear()},set:function(e){}},startDayOfSelectedMilestone:{get:function(){return this.getSelectedMilestone().start.getDate()},set:function(e){}},startMonthOfSelectedMilestone:{get:function(){return this.getSelectedMilestone().start.getMonth()+1},set:function(e){}},startYearOfSelectedMilestone:{get:function(){return this.getSelectedMilestone().start.getFullYear()},set:function(e){}}},methods:{getSemesterShortName:function(){return v.semesterShortName},startIntroJs:function(){d().setOptions({showProgress:!0,nextLabel:"weiter",prevLabel:"zurück",skipLabel:"abbrechen",hidePrev:!0,hideNext:!0,doneLabel:"fertig",exitOnEsc:!0,exitOnOverlayClick:!0,showStepNumbers:!0,keyboardNavigation:!0,scrollToElement:!0,steps:[{element:document.querySelector("#planing-component"),intro:"<p>Im Fernstudium sind Sie besonders gefordert, sich selbst zu organisieren und das Lernpensum gut einzuteilen. Wir wissen, dass viele von Ihnen berufstätig sind oder das Fernstudium gewählt haben, da sie die damit verbundene Flexibilität schätzen und brauchen. Dies stellt Sie gleichsam aber auch vor die Herausforderung, Ihr Semester eigenständig zu planen, sich selbst zu disziplinieren und die Übersicht zu behalten. Die Formulierung von Meilensteinen als Teilschritte auf dem Weg zu Ihrem persönlichen Ziel oder zur Prüfung helfen dabei, das Volumen eines Semesters übersichtlich zu machen, es zu strukturieren, zu organisieren und das Ziel im Auge zu behalten. Man darf dann auch auf jeden erreichten Meilenstein ein wenig stolz sein und sich selbst belohnen.</p>",position:"top",step:1},{element:document.querySelector("#add-milestone"),intro:"Für Ihre Semesterplanung können Sie Meilensteine auch selbst hinzufügen.",position:"top",step:2},{element:document.querySelector("#milestone-list-tab"),intro:"Hier können Sie die Meilensteine als Liste sehen.",position:"top",step:3},{element:document.querySelector(".milestone-element-name"),intro:"In der ersten Spalte ist der Name der Meilensteine zu sehen.",position:"top",step:4},{element:document.querySelector(".milestone-element-due"),intro:"Hier sehen Sie, wie viel Zeit Ihnen bis zum Abschluss des Meilensteins bleibt.",position:"top",step:5},{element:document.querySelector(".milestone-element-edit"),intro:'Durch einen Klick auf "bearbeiten" in der Listenansicht kann man in den Bearbeitungsmodus wechseln.',position:"top",step:6},{element:document.querySelector(".milestone-element-progress"),intro:"Der grüne Balken drückt aus, wie weit die Bearbeitung schon fortgeschritten ist.",position:"bottom",step:7},{element:document.querySelector("#milestone-timeline-tab"),intro:"Sie können sich die Meilensteine auch als Zeitleiste anzeigen lassen.",position:"top",step:8},{element:document.querySelector(".milestone-chart-container"),intro:"In der oberen Zeitleiste werden Meilensteine dargestellt.",position:"top",step:9},{element:document.querySelector(".activity-chart-container"),intro:"Im mittleren Teil sehen Sie, in welchen Bereichen Sie im Kurs bereits aktiv waren. Auf der X-Achse ist die Zeit abgebildet. Die Größe der Punkte zeigt Ihnen an, wie aktiv Sie waren.",position:"top",step:10},{element:document.querySelector(".filter-chart-container"),intro:"Diese Zeitleiste umfasst das gesamte Semester und ermöglicht Ihnen, den Betrachtungszeitraum der oberen Zeitleisten durch die äußeren Schieber auf Stunden, Tage oder Wochen zu begrenzen.",position:"top",step:11},{element:document.querySelector(".time-filters"),intro:"Hier können Sie auch noch weitere Filter nutzen.",position:"top",step:12}]}).onbeforechange((function(e){switch(e.id){case"milestone-timeline-tab":case"milestone-list-tab":e.click();break;case"theMilestoneModal":document.querySelector(".milestone-element-edit").click()}})).onafterchange((function(e){console.log(e.id),"strategy-introduction"===e.id&&document.querySelector("#close-modal").click()})).start()},showAdditionalCharts:function(){e("#additionalCharts").show(),e("#filter-presets").show(),m.add("milestone_view_switch",{selectedView:"timeline"})},hideAdditionalCharts:function(){e("#additionalCharts").hide(),e("#filter-presets").hide(),m.add("milestone_view_switch",{selectedView:"list"})},getMoodlePath:function(){return M.cfg.wwwroot},initializeChart:function(){var e=this;this.range=b,this.selectedDay=1,this.selectedMonth=1,this.selectedYear=(new Date).getFullYear();(new Date).getTime();if(l.get_ws("coursestructure",{courseid:parseInt(v.id,10),select:{modules:JSON.stringify(["assign","data","hvp","checklist","url","studentquiz","page","feedback","forum","resource","glossary","quiz","wiki"])}},(function(t){try{let s=JSON.parse(t.data),i=new Array(s.length);for(let e in s){let t=0;for(let i in s)s[e]!==s[i]&&(+s[i].pos_section<+s[e].pos_section||+s[i].pos_module<+s[e].pos_module)&&t++;for(;"object"==typeof i[t];)t++;i[t]=s[e]}e.resources=i;for(let t in e.calendar){let s=e.calendar[t];if("course"!==s.eventtype&&"group"!==s.eventtype)continue;let i=o.unix(+s.timestart).format("DD.MM.YYYY"),n={course_id:v.id,id:s.id,instance_id:null,instance_title:null,instance_type:"course"===s.eventtype?"kurstermin":"gruppentermin",instance_url_id:null,module_id:null,name:s.name+" ["+i+"]",pos_module:null,pos_section:null,section:null,section_id:999,section_name:null};e.resources.push(n)}e.createMilestonePicker()}catch(t){console.error(t)}})),this.margins=y,this.width=S,null!==this.milestones&&void 0!==this.milestones){this.milestones.forEach((function(e,t){e.start=new Date(e.start),e.end=new Date(e.end),e.g=1})),this.updateLanes(),this.xmin=t.min(this.milestones,(function(e){return e.start})),this.xmax=t.max(this.milestones,(function(e){return e.end})),this.ymax=3;var s=t.scaleTime().domain(this.range).range([0,this.width-this.padding]),i=t.scaleLinear().domain([0,this.ymax]).range([0,this.height]);t.scaleOrdinal().range(this.colors);this.xAxis=t.axisTop().scale(s).ticks(10).tickFormat(l.multiFormat),this.yAxis=t.axisLeft().scale(i).ticks(0),this.chart=t.select(".chart.ms-chart .milestone-chart-container svg g"),this.x_axis_call=this.chart.append("g").attr("class","x axis").attr("transform","translate(0,"+this.height+")").call(this.xAxis),this.y_axis_call=this.chart.append("g").attr("class","y axis").call(this.yAxis),this.updateChart(this.range)}},getMilestones:function(){return this.milestones},getMilestonesById:function(e){return this.milestone.filter((function(t){return t.id===e}))},xx:function(e){return e=new Date(e),t.scaleTime().domain(this.range).range([0,this.width-this.padding])(e)},duration:function(e,s){e=new Date(e),s=new Date(s);var i=t.scaleTime().domain(this.range).range([0,this.width-this.padding])(e),n=t.scaleTime().domain(this.range).range([0,this.width-this.padding])(s)-i;return n<10?10:n},z:function(){return t.scaleOrdinal().range(this.colors)},getYLane:function(e){return this.milestones.filter((function(t){return t.id===e}))[0].yLane},updateChart:function(e){this.updateLanes(),this.range=e,this.x_axis_call.transition().duration(500).call(this.xAxis.scale(t.scaleTime().domain(this.range).range([0,this.width-this.padding])).ticks(10).tickFormat(l.multiFormat)),this.y_axis_call.transition().duration(0).call(this.yAxis.scale(t.scaleLinear().domain([0,this.ymax]).range([0,this.height]))),this.$forceUpdate()},updateLanes:function(){for(var e=[[],[],[],[],[]],t=0;t<this.milestones.length;t++)e:for(var s=0;s<e.length;s++){if(0===e[s].length){e[s].push(this.milestones[t]),this.milestones[t].yLane=s;break e}for(var i=!0,n=0;n<e[s].length;n++)o(this.milestones[t].end).diff(o(e[s][n].start))<0||o(this.milestones[t].start).diff(o(e[s][n].end))>0||(i=!1);if(i){e[s].push(this.milestones[t]),this.milestones[t].yLane=s;break e}}this.maxLanes=e.filter((function(e){return e.length>0})).length,this.height=24*this.maxLanes},showModal:function(e){this.selectedMilestone=e,this.startDate=this.getSelectedMilestone().start,this.endDate=this.getSelectedMilestone().end,this.reflectionsFormVisisble="reflected"===this.getSelectedMilestone().status,this.modalVisible=!0,this.getSelectedMilestone().mod=!1,e>0&&m.add("milestone_edit_dialog_open",{milestoneId:this.getSelectedMilestone().id,name:this.getSelectedMilestone().name,start:new Date(this.getSelectedMilestone().start).getTime(),end:new Date(this.getSelectedMilestone().end).getTime(),status:this.getSelectedMilestone().status,objective:this.getSelectedMilestone().objective,resources:this.getSelectedMilestone().resources.map((function(e){return{name:e.instance_title,section:e.section,type:e.instance_type,done:void 0!==e.checked}})),strategies:this.getSelectedMilestone().strategies.map((function(e){return{name:e.id,done:void 0!==e.checked}}))})},closeModal:function(e=!0){this.modalVisible=!1,!1!==e&&(this.updateMilestoneStatus(),this.updateChart(this.range),m.add("milestone_dialog_close",{dialogOpen:!1}))},showReflectionModal:function(e){this.selectedMilestone=e,this.reflectionsFormVisisble="reflected"===this.getSelectedMilestone().status,this.modalReflectionVisible=!0,m.add("milestone_reflection_dialog_open",{milestoneId:this.getSelectedMilestone().id,name:this.getSelectedMilestone().name,start:new Date(this.getSelectedMilestone().start).getTime(),end:new Date(this.getSelectedMilestone().end).getTime(),status:this.getSelectedMilestone().status,objective:this.getSelectedMilestone().objective,resources:this.getSelectedMilestone().resources.map((function(e){return{name:e.instance_title,section:e.section,type:e.instance_type,done:void 0!==e.checked}})),strategies:this.getSelectedMilestone().strategies.map((function(e){return{name:e.id,done:void 0!==e.checked}}))})},closeReflectionModal:function(e){this.modalReflectionVisible=!1,this.updateMilestoneStatus(),m.add("reflection_dialog_close",{dialogOpen:!1})},getSelectedMilestone:function(){if(-1===this.selectedMilestone)return this.emptyMilestone;var e=this;return this.milestones.filter((function(t){return t.id===e.selectedMilestone}))[0]},showEmptyMilestone:function(e){this.selectedMilestone=-1;var t=new Date;this.startDate=t,this.endDate=t,this.modalVisible=!0,m.add("milestone_dialog_open_new",{dialogOpen:!0})},updateName:function(e){this.invalidName=""===this.getSelectedMilestone().name},updateObjective:function(e){this.invalidObjective=""===this.getSelectedMilestone().objective},validateMilestoneForm:function(){var t=!0;if(0===this.getSelectedMilestone().name.length&&(this.invalidName=!0,t=!1),0===this.getSelectedMilestone().objective.length&&(this.invalidObjective=!0,t=!1),0===this.getSelectedMilestone().resources.length&&this.resources.length>0&&(this.invalidResources=!0,t=!1),0===this.getSelectedMilestone().strategies.length&&(this.invalidStrategy=!0,t=!1),t)if(-1===this.selectedMilestone){let t=this.createMilestone();s.nextTick().then(s=>{if(e("#milestone-list-tab").hasClass("active")||e("#milestone-archive-list-tab").hasClass("active")){let e;this.milestones.forEach((function(s){s.id===t&&(e=s)})),"object"==typeof e&&("missed"===e.status||"reflected"===e.status?this.moveToMilestoneArchiveListEntry(t,!0):this.moveToMilestoneListEntry(t,!0))}else e("#milestone-timeline-tab").hasClass("active")&&this.moveToMilestoneTimelineEntry(t,3)})}else e("#theMilestoneModal").modal("hide"),this.updateMilestoneStatus(),m.add("milestone_updated",{milestoneId:this.getSelectedMilestone().id,name:this.getSelectedMilestone().name,start:new Date(this.getSelectedMilestone().start).getTime(),end:new Date(this.getSelectedMilestone().end).getTime(),status:this.getSelectedMilestone().status,objective:this.getSelectedMilestone().objective,resources:this.getSelectedMilestone().resources.map((function(e){return{name:e.instance_title,section:e.section,type:e.instance_type,done:void 0!==e.checked}})),strategies:this.getSelectedMilestone().strategies.map((function(e){return{name:e.id,done:void 0!==e.checked}}))}),e("#milestone-list-tab").hasClass("active")||e("#milestone-archive-list-tab").hasClass("active")?"missed"===this.getSelectedMilestone().status||"reflected"===this.getSelectedMilestone().status?this.moveToMilestoneArchiveListEntry(this.getSelectedMilestone().id,!0):this.moveToMilestoneListEntry(this.getSelectedMilestone().id,!0):e("#milestone-timeline-tab").hasClass("active")&&this.moveToMilestoneTimelineEntry(this.getSelectedMilestone().id,3)},createMilestone:function(s){this.emptyMilestone.id=Math.ceil(1e5*Math.random());let i=this.emptyMilestone.id;this.emptyMilestone.start.setHours(0,0,0),this.emptyMilestone.end.setHours(23,59,59),this.milestones.push(this.emptyMilestone),m.add("milestone_created",{milestoneId:this.emptyMilestone.id,name:this.emptyMilestone.name,start:new Date(this.emptyMilestone.start).getTime(),end:new Date(this.emptyMilestone.end).getTime(),status:this.emptyMilestone.status,objective:this.emptyMilestone.objective,resources:this.emptyMilestone.resources.map((function(e){return{name:e.instance_title,section:e.section,type:e.instance_type,done:void 0!==e.checked}})),strategies:this.emptyMilestone.strategies.map((function(e){return{name:e.id,done:void 0!==e.checked}}))});t.scaleTime().domain(this.range).range([0,S]),t.scaleLinear().domain([0,this.ymax]).range([0,this.height]);return this.updateMilestoneStatus(),this.updateChart(this.range),this.emptyMilestone={id:10,name:"",objective:"",start:new Date,end:new Date,status:"progress",progress:0,resources:[],strategies:[],reflections:[],yLane:0,mod:!1},e("#theMilestoneModal").modal("hide"),i},addMilestones:function(e){console.log("Is this function used anymore?");for(var s=0;s<e.length;s++)e[s].start=new Date(e[s].start.split("T")[0]),e[s].end=new Date(e[s].end.split("T")[0]),this.milestones.push(e[s]);t.scaleTime().domain(this.range).range([0,S]),t.scaleLinear().domain([0,this.ymax]).range([0,this.height]);this.updateMilestoneStatus(),this.updateChart(this.range)},removeMilestone:function(){this.closeModal(!1),e("div.modal-backdrop.show").remove(),m.add("milestone_removed",{milestoneId:this.getSelectedMilestone().id,name:this.getSelectedMilestone().name,start:new Date(this.getSelectedMilestone().start).getTime(),end:new Date(this.getSelectedMilestone().end).getTime(),status:this.getSelectedMilestone().status,objective:this.getSelectedMilestone().objective,resources:this.getSelectedMilestone().resources.map((function(e){return{name:e.instance_title,section:e.section,type:e.instance_type,done:void 0!==e.checked}})),strategies:this.getSelectedMilestone().strategies.map((function(e){return{name:e.id,done:void 0!==e.checked}}))});for(var t=0;t<this.milestones.length;t++)this.milestones[t].id===this.getSelectedMilestone().id&&(this.milestones.splice(t,1),this.selectedMilestone=-1);this.updateMilestones(),this.$forceUpdate()},validateStartDate:function(e){e<=this.dpRange.to||e>=this.dpRange.from?this.invalidStartDate=!0:(e>this.endDate&&(this.invalidEndDate=!0),this.invalidStartDate=!1,this.getSelectedMilestone().start=e)},validateEndDate:function(e){e<=this.dpRange.to||e<this.getSelectedMilestone().start||e>=this.dpRange.from?this.invalidEndDate=!0:(this.invalidEndDate=!1,this.getSelectedMilestone().end=e)},daySelected:function(e,t){var s=e?parseInt(e.target.value):t;if(-1!==[4,6,9,11].indexOf(parseInt(this.selectedMonth,10))&&31===parseInt(s,10))return this.invalidDay=!0,void this.selectedMonth++;if(2===parseInt(this.selectedMonth,10)&&s>29)this.invalidDay=!0;else{if(2!==parseInt(this.selectedMonth,10)||29!==s||parseInt(this.selectedYear,10)%4==0&&parseInt(this.selectedYear,10)%100!=0||parseInt(this.selectedYear,10)%400==0)return this.invalidDay=!1,this.selectedDay=s,!1===this.invalidDay&&(this.setEndDateFromSelectedValues(),!0);this.invalidDay=!0}},monthSelected:function(e){this.selectedMonth=e.target.value,this.daySelected(void 0,this.selectedDay)},yearSelected:function(e){this.selectedYear=e.target.value,this.setEndDateFromSelectedValues()},setEndDateFromSelectedValues:function(){var e=new Date(this.selectedYear,this.selectedMonth-1,this.selectedDay,23,59,59);o(e).diff(o(v.startDate),"minutes")>0&&o(e).diff(o(new Date),"months")<v.maxPlaningPeriod?(this.invalidEndDate=!1,this.getSelectedMilestone().end=e):this.invalidEndDate=!0},startDaySelected:function(e,t){var s=e?parseInt(e.target.value):t;if(-1!==[4,6,9,11].indexOf(parseInt(this.selectedStartMonth,10))&&31===parseInt(s,10))return this.invalidStartDay=!0,void this.selectedStartMonth++;if(2===parseInt(this.selectedStartMonth,10)&&s>29)this.invalidDay=!0;else{if(2!==parseInt(this.selectedStartMonth,10)||29!==s||parseInt(this.selectedYear,10)%4==0&&parseInt(this.selectedYear,10)%100!=0||parseInt(this.selectedYear,10)%400==0)return this.invalidDay=!1,this.selectedStartDay=s,!1===this.invalidStartDay&&(this.setStartDateFromSelectedValues(),!0);this.invalidDay=!0}},startMonthSelected:function(e){this.selectedStartMonth=e.target.value,this.startDaySelected(void 0,this.selectedStartDay)},startYearSelected:function(e){this.selectedStartYear=e.target.value,this.setStartDateFromSelectedValues()},setStartDateFromSelectedValues:function(){var e=new Date(this.selectedStartYear,this.selectedStartMonth-1,this.selectedStartDay,0,0,0);o(e).diff(o(v.startDate),"minutes")>0&&o(e).diff(o(new Date),"months")<v.maxPlaningPeriod?(this.invalidStartDate=!1,this.getSelectedMilestone().start=e):this.invalidStartDate=!0},dayRange:function(){return[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31]},monthRange:function(){return l.monthRange},yearRange:function(){return[v.startDate.getFullYear(),v.endDate.getFullYear()]},fromNow:function(e){return o(e).fromNow()},getReadableTime:function(e){return o(e).format("d.MM.YYYY, HH:mm")},strategiesByCategory:function(e){return this.strategies.filter((function(t){return t.category===e}))},strategyById:function(e){return JSON.parse(JSON.stringify(this.strategies.filter((function(t){return t.id===e}))[0]))},resourcesBySection:function(e){return this.resources.filter((function(t){return parseInt(t.section_id,10)===parseInt(e,10)}))},resourceSections:function(){for(var e={},t=Object.keys(this.resources),s=0;s<t.length;s++){var i=t[s];if(void 0===this.resources[i])return 0;e[this.resources[i].section_id]={name:" "===this.resources[i].section_name?"(Einführung)":this.resources[i].section_name,id:this.resources[i].section_id}}return e},resourceById:function(e){return JSON.parse(JSON.stringify(this.resources.filter((function(t){return parseInt(t.id,10)===parseInt(e,10)}))[0]))},getInstanceTypeTitel:function(e){switch(e){case"forum":return"Forum";case"assign":return"Einsendeaufgabe";case"quiz":case"studentquiz":return"Selbsttest";case"page":return"Text";case"kurstermin":return"Termin";case"data":return"Text";case"hvp":case"checklist":return"";case"url":return"Link";case"feedback":return"Feedback";case"resource":return"Material";case"glossary":return"Glossar";case"wiki":return"Wiki";default:return e}},strategySelected:function(e){var t=this.strategyById(e);-1===this.getSelectedMilestone().strategies.indexOf(t)&&this.getSelectedMilestone().strategies.push(t),this.invalidStrategy=!(this.getSelectedMilestone().strategies.length>0)},isSelectedStrategy:function(e){return this.getSelectedMilestone().strategies.filter((function(t){return t.id===e})).length>0},strategyRemove:function(e){for(var t=0;t<this.getSelectedMilestone().strategies.length;t++)this.getSelectedMilestone().strategies[t].id===e&&this.getSelectedMilestone().strategies.splice(t,1);this.invalidStrategy=!(this.getSelectedMilestone().strategies.length>0)},resourceSelected:function(e){var t=this.resourceById(e.target.value);-1===this.getSelectedMilestone().resources.indexOf(t)&&this.getSelectedMilestone().resources.push(t),this.invalidResources=!(this.getSelectedMilestone().resources.length>0)},resourceRemove:function(e){for(var t=0;t<this.getSelectedMilestone().resources.length;t++)this.getSelectedMilestone().resources[t].id===e&&this.getSelectedMilestone().resources.splice(t,1);this.invalidResources=!(this.getSelectedMilestone().resources.length>0)},limitTextLength:function(e,t,s){var i=e.length;return i>t?e.substr(0,t-4)+"..."+(s?e.substr(i-4,i):""):e},determineMilestoneProgress:function(e){return(e.resources.filter((function(e){return!0===e.checked})).length/e.resources.length+e.strategies.filter((function(e){return!0===e.checked})).length/e.strategies.length)/2},updateMilestones:function(){this.sortMilestones();let e=this.milestones.filter((function(e){return!0!==e.mod||(void 0===e.mod&&(e.mod=!1),!1)}));l.get_ws("setmilestones",{data:{courseid:parseInt(v.id,10),milestones:JSON.stringify(e),settings:JSON.stringify({})}},(function(e){}))},updateMilestoneStatus:function(){if(null!==this.milestones&&void 0!==this.milestones){for(var e=new Date,t=0;t<this.milestones.length;t++){var s=o(e).diff(o(this.milestones[t].end),"minutes");this.milestones[t].status="progress",this.milestones[t].progress=this.determineMilestoneProgress(this.milestones[t]),s<0&&s>-4320&&1!==this.milestones[t].progress&&(this.milestones[t].status="urgent"),s>0&&1!==this.milestones[t].progress&&(this.milestones[t].status="missed"),1===this.milestones[t].progress&&(this.milestones[t].status="ready"),1===this.milestones[t].progress&&this.milestones[t].reflections.length>0&&(this.milestones[t].status="reflected")}this.hightlightSelectedResources(),this.updateMilestones()}},hightlightSelectedResources:function(){var t="";e(".badge-ms").each((function(){e(this).remove()}));let s=this;for(var i=0;i<this.milestones.length;i++){let a=this.milestones[i].id,r=this.milestones[i];for(var n=0;n<this.milestones[i].resources.length;n++)if(t=e("<span></span>").addClass("badge badge-secondary badge-ms").attr("data-toggle","tooltip").click((function(){"missed"===r.status||"reflected"===r.status?s.moveToMilestoneArchiveListEntry(a,!0):s.moveToMilestoneListEntry(a,!0)})).css({"user-select":"none",cursor:"pointer"}),!this.milestones[i].resources[n].checked&&"missed"===this.milestones[i].status&&new Date<=o(this.milestones[i].end).add(1,"w").toDate()&&(t.html('<i class="fa fa-exclamation"></i>'+this.limitTextLength(this.milestones[i].name,14)).attr("title",'Dieses Element haben Sie im Meilenstein "'+this.milestones[i].name+'" noch nicht erledigt oder als "erledigt" markiert.').addClass("badge-missed"),e("#module-"+this.milestones[i].resources[n].instance_url_id+" div.activityinstance").append(t)),this.milestones[i].resources[n].checked||"progress"!==this.milestones[i].status||(t.html('<i class="fa fa-square-o"></i>'+this.limitTextLength(this.milestones[i].name,14)).attr("title",'Dieses Element haben Sie im Meilenstein "'+this.milestones[i].name+'" noch nicht erledigt oder als "erledigt" markiert.').addClass("badge-progress"),e("#module-"+this.milestones[i].resources[n].instance_url_id+" div.activityinstance").append(t)),this.milestones[i].resources[n].checked||"urgent"!==this.milestones[i].status||(t.html('<i class="fa fa-square-o"></i>'+this.limitTextLength(this.milestones[i].name,14)).attr("title",'Dieses Element haben Sie im Meilenstein "'+this.milestones[i].name+'" noch nicht erledigt oder als "erledigt" markiert.').addClass("badge-urgent"),e("#module-"+this.milestones[i].resources[n].instance_url_id+" div.activityinstance").append(t)),this.milestones[i].resources[n].checked){t.html('<i class="fa fa-check-square"></i><span>'+this.limitTextLength(this.milestones[i].name,14)+"</span>").attr("title",'Dieses Element haben Sie im Meilenstein "'+this.milestones[i].name+'" bereits als "erledigt" markiert.').addClass("badge-ready"),e("#module-"+this.milestones[i].resources[n].instance_url_id+" div.activityinstance").append(t)}}},toggleReflectionsForm:function(){this.reflectionsFormVisisble=!this.reflectionsFormVisisble,m.add("reflections_open",{formVisible:!0})},validateReflectionForm:function(){this.invalidReflections=[];let e=this.getSelectedMilestone().reflections;for(let t=0;t<e.length;t++)(void 0===e[t]||null===e[t]||0===e[t].length)&&this.invalidReflections.push(t+1);4===e.length&&0===this.invalidReflections.length&&this.submitReflections()},submitReflections:function(){this.getSelectedMilestone().status="reflected",m.add("reflections_completed",{milestoneId:this.getSelectedMilestone().id,name:this.getSelectedMilestone().name,reflections:this.getSelectedMilestone().reflections});this.milestones.filter((function(e){return e.reflections}));this.updateMilestones(),e("#theReflectionModal").modal("hide")},setFilterPreset:function(e){var t=[],s=new Date;switch(this.filterPreset=e,m.add("time_filter_selected",{selectedFilter:e}),e){case"next-week":t=[new Date(s.getTime()+864e5),new Date(s.getTime()+6048e5)];break;case"next-month":t=[new Date(s.getTime()+864e5),new Date(s.getTime()+2592e6)];break;case"today":t=[new Date(s.getTime()-2592e5),new Date(s.getTime()+2592e5)];break;case"last-week":t=[new Date(s.getTime()-6048e5),new Date(s.getTime()+864e5)];break;case"last-month":t=[new Date(s.getTime()-2592e6),new Date(s.getTime()+864e5)];break;case"semester":t=[v.startDate,v.endDate]}this.timeFilterChart.replaceFilter(a.filters.RangedFilter(t[0],t[1])),this.timeFilterChart.filterTime()},sortMilestones:function(){this.milestones.sort((function(e,t){let s=new Date(e.end),i=new Date(t.end),n=new Date;return"urgent"===e.status&&"urgent"!==t.status?-1:"urgent"===t.status&&"urgent"!==e.status?1:"progress"===e.status&&"progress"!==t.status?-1:"progress"===t.status&&"progress"!==e.status?1:"ready"===e.status&&"ready"!==t.status?-1:"ready"===t.status&&"ready"!==e.status?1:"reflected"===e.status&&"reflected"!==t.status?-1:"reflected"===t.status&&"reflected"!==e.status?1:e.end>=n&&t.end<n?-1:t.end>=n&&e.end<n?1:s<n&&i<n?i-s:s-i}))},createMilestonePicker:function(){let t=this;e(document).ready((function(){e(".activityinstance").each((function(s){try{let s=e(this).find("a").eq(0);if(1!==s.length)return;let i=s.attr("href");if(void 0===i||i.length<=0)return;let n=i.indexOf("id=");if(-1===n)return;let a=+i.slice(n+3);if("number"!=typeof a||a<0)return;let r=e('                                             <div class="dropdown milestone_picker">                                                 <a href="#" class="badge dropdown-toggle"                                                     href="#" role="button"                                                     data-toggle="dropdown" aria-haspopup="true"                                                     aria-expanded="false">                                                     Meilensteine                                                 </a>                                                 <div class="dropdown-menu" aria-labelledby="dropdownMenuLink">                                                 </div>                                             </div>                                         ').insertAfter(s),l=r.find(".dropdown-menu");l.css({display:"none"});let d=r.find("a");d.css({"background-color":"transparent",color:"black","font-weight":"normal"}),e(document).click((function(t){e(t.target).is(".milestone_picker .dropdown-menu, .milestone_picker .dropdown-menu *")||e(".milestone_picker .dropdown-menu").css({display:"none"})})),d.click((function(s){if(s.preventDefault(),"block"!==l.css("display")){l.empty();let s=function(e){try{let s="";return t.milestones.forEach(t=>{if("reflected"===t.status||"missed"===t.status&&new Date>o(t.end).add(1,"w").toDate())return;let i="fa-square";"object"==typeof t.resources&&t.resources.forEach(t=>{+t.instance_url_id===e&&(i="fa-check-square")}),s+='<a class="dropdown-item" href="#" id="'+t.id+'"><i class="icon fa '+i+'"></i>'+t.name+"</a>"}),s.length<=0?'<span class="px-2" style="user-select:none;">Kein Meilenstein</span>':s}catch(e){return'<div class="dropdown-item">Meilensteine konnten nicht geladen werden.</div>'}}(a);e(s).prependTo(l),e(".milestone_picker .dropdown-menu").css({display:"none"}),l.find("a.dropdown-item").each((function(){let s=e(this),i=+s.attr("id"),n=e(this).find("i.icon");"number"==typeof i&&s.click((function(e){if(e.preventDefault(),"object"==typeof t.milestones&&"object"==typeof t.resources)for(let e in t.milestones)if(t.milestones[e].id===i)for(let s in t.resources)if(+t.resources[s].instance_url_id===a){if("object"==typeof t.milestones[e].resources)if(Object.keys(t.milestones[e].resources).length>0){let i=null;for(let s in t.milestones[e].resources)+t.milestones[e].resources[s].instance_url_id===a&&(i=s);null!==i?(t.milestones[e].resources.splice(i,1),n.removeClass("fa-check-square"),n.addClass("fa-square")):(t.milestones[e].resources.push(t.resources[s]),n.addClass("fa-check-square"),n.removeClass("fa-square"))}else t.milestones[e].resources.push(t.resources[s]),n.addClass("fa-check-square"),n.removeClass("fa-square");else t.milestones[e].resources=array(t.resources[s]),n.addClass("fa-check-square"),n.removeClass("fa-square");t.updateMilestoneStatus()}}))})),l.css({display:"block"})}else e(".milestone_picker .dropdown-menu").css({display:"none"})}))}catch(e){}}))}))},moveToMilestoneTimelineEntry:function(t,s){try{this.showAdditionalCharts(),e('a[href="#view-timeline"]').tab("show");let n=void 0;if(this.milestones.forEach(e=>{e.id===t&&(n=e)}),"object"==typeof n){let t=new Date(n.start.toISOString());if(t.setDate(t.getDate()-s),t.setHours(0),t.setMinutes(0),t.setSeconds(0),n.stop instanceof Date)var i=new Date(n.stop.toISOString());else i=new Date(n.start.toISOString());i.setDate(i.getDate()+s),i.setHours(23),i.setMinutes(59),i.setSeconds(59),this.timeFilterChart.replaceFilter(a.filters.RangedFilter(t,i)),this.timeFilterChart.filterTime(),e("html, body").animate({scrollTop:e("div.ladtopics").offset().top-e("nav.navbar").outerHeight()},1e3),e("#filter-presets").find("button").css("text-decoration","none")}}catch(e){}},moveToMilestoneArchiveListEntry:function(t,s){try{this.hideAdditionalCharts(),e('a[href="#view-archive-list"]').tab("show");let i=[];e("div.milestone-entry-details").each((function(){let n=e(this);if(n.attr("id")==="milestone-entry-archive-"+t){let e=function(){n.off("show.bs.collapse",e),i.push(new Promise((e,t)=>{let s=function(){return n.off("shown.bs.collapse",s),e()};n.on("shown.bs.collapse",s)}))};n.on("show.bs.collapse",e),n.collapse("show"),n.off("show.bs.collapse",e)}else if(s){let e=function(){n.off("hide.bs.collapse",e),i.push(new Promise((e,t)=>{let s=function(){return n.off("hidden.bs.collapse",s),e()};n.on("hidden.bs.collapse",s)}))};n.on("hide.bs.collapse",e),n.collapse("hide"),n.off("hide.bs.collapse",e)}})),Promise.all(i).then(s=>{e("#milestone-entry-archive-"+t).length&&e("html, body").animate({scrollTop:e("#milestone-entry-archive-"+t).parent().offset().top-e("nav.navbar").outerHeight()},1e3)})}catch(e){}},moveToMilestoneListEntry:function(t,s){try{this.hideAdditionalCharts(),e('a[href="#view-list"]').tab("show");let i=[];e("div.milestone-entry-details").each((function(){let n=e(this);if(n.attr("id")==="milestone-entry-"+t){let e=function(){n.off("show.bs.collapse",e),i.push(new Promise((e,t)=>{let s=function(){return n.off("shown.bs.collapse",s),e()};n.on("shown.bs.collapse",s)}))};n.on("show.bs.collapse",e),n.collapse("show"),n.off("show.bs.collapse",e)}else if(s){let e=function(){n.off("hide.bs.collapse",e),i.push(new Promise((e,t)=>{let s=function(){return n.off("hidden.bs.collapse",s),e()};n.on("hidden.bs.collapse",s)}))};n.on("hide.bs.collapse",e),n.collapse("hide"),n.off("hide.bs.collapse",e)}})),Promise.all(i).then(s=>{e("#milestone-entry-"+t).length&&e("html, body").animate({scrollTop:e("#milestone-entry-"+t).parent().offset().top-e("nav.navbar").outerHeight()},1e3)})}catch(e){}},modAlert:function(t,s){let i=e("#moderationAlert");switch(i.removeClass(),i.addClass("alert"),t){case"success":i.addClass("alert-success");break;case"danger":i.addClass("alert-danger");break;case"warning":i.addClass("alert-warning");break;case"info":i.addClass("alert-info");break;default:i.addClass("alert-secondary")}i.text(s),i.fadeIn("slow",(function(){e(this).delay(2e3).fadeOut("slow")}))},modLoadPath:function(t){try{let t=document.getElementById("modImportedFile").files[0];"string"==typeof t.name&&t.name.length>0&&(e("#modLoadPathLabel").text(t.name),e("#moderationModal").one("hidden.bs.modal",(function(){e("#modLoadPathLabel").text("Bitte wählen Sie eine Datei aus."),document.getElementById("modImportedFile").value=""})))}catch(e){new p(e)}},modExportMilestones:function(){let e=this.milestones.filter((function(e){return!0!==e.mod}));e.length<=0?this.modAlert("warning","Keine Meilensteine vorhanden."):this.exportMilestones(e)},modLoadMilestones:function(){try{let t=document.getElementById("modImportedFile").files[0];if(e("#modLoadPathLabel").text("Bitte wählen Sie eine Datei aus."),document.getElementById("modImportedFile").value="",void 0===t)return void this.modAlert("warning","Bitte wählen Sie eine Datei aus.");if("application/json"!==t.type)return void this.modAlert("warning","Es wird eine Datei im JSON-Format benötigt.");if(t.size<=0)return void this.modAlert("danger","Die Datei ist fehlerhaft.");const s=new FileReader,i=this;s.readAsText(t),s.onload=function(e){try{let t=e.target.result,s=JSON.parse(t);if("object"!=typeof s||!Array.isArray(s))return void this.modAlert("danger","Die Datei ist fehlerhaft.");s.forEach((function(e){Object.assign(i.emptyMilestone,e),i.emptyMilestone.start=o(e.start).toDate(),i.emptyMilestone.end=o(e.end).toDate(),i.createMilestone()})),i.updateMilestones(),i.modAlert("success","Meilensteine wurden geladen.")}catch(e){new p(e)}},s.onerror=function(e){i.modAlert("warning","Die Datei konnte nicht gelesen werden."),new p(e)}}catch(e){this.modAlert("danger","Konnte die Meilensteine nicht laden."),new p(e)}},modSaveSelect:function(){let t=this.milestones.filter((function(e){return!0!==e.mod}));t.length<=0?this.modAlert("warning","Keine Meilensteine vorhanden."):e("#modSaveInterest").is(":checked")?this.modSaveMilestones("interest",t,!0):e("#modSaveOrientation").is(":checked")?this.modSaveMilestones("orientation",t,!0):e("#modSaveExam").is(":checked")?this.modSaveMilestones("exam",t,!0):e("#modSaveLocal").is(":checked")&&this.exportMilestones(t)},modResetSelect:function(){!0===confirm("Wollen Sie wirklich alle Meilensteine zurücksetzen?")&&(e("#modSaveInterest").is(":checked")?this.modSaveMilestones("interest",[],!1):e("#modSaveOrientation").is(":checked")?this.modSaveMilestones("orientation",[],!1):e("#modSaveExam").is(":checked")?this.modSaveMilestones("exam",[],!1):e("#modSaveLocal").is(":checked")?this.resetMilestones():_this.modAlert("danger","Unbekannte Auswahl"))},modResetPlan:function(){if(!0===confirm("Wollen Sie wirklich ihren Semesterplan zurücksetzen?")){let e=[];e.push(new Promise((e,t)=>{l.get_ws("userpreferences",{data:{setget:"set",courseid:parseInt(v.id,10),fieldname:"ladtopics_survey_done",value:0}},(function(t){return e()}))})),e.push(new Promise((e,t)=>{l.get_ws("userpreferences",{data:{setget:"set",courseid:parseInt(v.id,10),fieldname:"ladtopics_survey_results",value:""}},(function(t){return e()}))})),Promise.all(e).then(e=>{location.reload()},e=>{console.log(e)})}},modSaveMilestones:function(e,t,s=!0){let i=this;try{l.get_ws("setmilestoneplan",{data:{courseid:parseInt(v.id,10),milestones:JSON.stringify(t),plan:e}},(function(e){let t=JSON.parse(e.data);if(!0===t.success){if(console.log("success"),s)console.log("reset"),i.milestones=[],i.updateMilestones();else{let e=[];for(let t in i.milestones)!0!==i.milestones[t].mod&&e.push(i.milestones[t]);i.milestones=e}i.getMilestonePlan(),i.modAlert("success","Meilensteine wurden aktualisiert.")}else"string"==typeof t.debug&&t.debug.length>0?i.modAlert("danger",t.debug):i.modAlert("danger","Unbekannter Fehler")}))}catch(e){this.modAlert("danger","Konnte die Meilensteine nicht speichern.")}},resetMilestones:function(){try{this.milestones=[],this.updateMilestones(),this.modAlert("success","Meilensteine wurden zurückgesetzt.")}catch(e){this.modAlert("danger","Konnte die Meilensteine nicht zurücksetzen."),new p(e)}},exportMilestones:function(e){try{var t=document.createElement("a");let s=JSON.stringify(e);t.href="data:text/json;charset=utf-8,"+s;let i=new Date,n=i.getFullYear().toString().padStart(4,"0"),a=i.getMonth()+1;a=a.toString().padStart(2,"0");let r=i.getDate().toString().padStart(2,"0"),o=i.getHours().toString().padStart(2,"0"),l=i.getMinutes().toString().padStart(2,"0");t.download="Meilensteinplanung_"+n+a+r+o+l+".json",t.click()}catch(e){new p(e)}},sendMail:function(e,t){try{l.get_ws("sendmail",{courseid:parseInt(v.id,10),subject:"hello",text:"jo"},(function(e){}))}catch(e){console.log(e)}},modGetStatisticData:function(s){try{let i=s;new Promise((e,t)=>{l.get_ws("statistics",{courseid:parseInt(v.id,10)},(function(t){let s=JSON.parse(t.data);return e(s)}))}).then(s=>{e("#stUserList").length>0&&e("#stUserList tr:gt(1)").remove(),e("#modWorkload tr").not(":first").not(":last").remove(),i.modStatistics.users=s.num_users?+s.num_users:0,i.modStatistics.surveys=s.num_survey?+s.num_survey:0,i.modStatistics.msProgessed=0,i.modStatistics.msReady=0,i.modStatistics.msUrgent=0,i.modStatistics.msMissed=0,i.modStatistics.msReflected=0,i.modStatistics.ptExam=0,i.modStatistics.ptOrientation=0,i.modStatistics.ptInterest=0,i.modStatistics.ptNoAnswer=0,i.modStatistics.ptW1=0,i.modStatistics.ptW4=0,i.modStatistics.ptWA=0,i.modStatistics.ptWA2=0,i.modStatistics.ptWA4=0,i.modStatistics.ptWANA=0,i.modStatistics.ptSum=0,i.modStatistics.ptMS=0,i.modStatistics.ptUser=0,i.modStatistics.milestones=0;let n=function(s,i,n){for(let e in i)i[e]<=0&&delete i[e];if(Object.keys(i).length<=0)return;let a=e(s);if(a.length>0){a.empty();let l=a.width()/2,d=l/2-20,c=t.select(s).append("svg").attr("width",l).attr("height",l);c.append("g").attr("class","slices").attr("transform","translate("+l/2+","+l/2+")"),c.append("g").attr("class","labels").attr("transform","translate("+l/2+","+l/2+")");n=t.scaleOrdinal().domain(i).range(n);var r=t.pie().value((function(e){return e.value}))(t.entries(i));e(s+" svg").css({margin:"auto",display:"block"});var o=t.arc().innerRadius(0).outerRadius(d);c.select(".slices").selectAll("path.slice").data(r).enter().append("path").attr("d",o).attr("fill",(function(e){return n(e.data.key)})).attr("stroke","black").style("stroke-width","2px").style("opacity",.7),c.select(".labels").selectAll("text").data(r).enter().append("text").text((function(e){return e.data.key+" ("+e.data.value+")"})).attr("transform",(function(e){return"translate("+o.centroid(e)+")"})).style("text-anchor","middle").style("font-size",17)}},a={};if(s.users){for(let t in s.users){i.modStatistics.ptUser++;let n=0;if(s.users[t].surveyDone&&+s.users[t].surveyDone.value>0&&(n=1),s.users[t].survey){if(i.modStatistics.ptSum++,s.users[t].survey.value){switch(s.users[t].survey=JSON.parse(s.users[t].survey.value),s.users[t].survey.objectives){case"f1a":i.modStatistics.ptExam++;break;case"f1b":i.modStatistics.ptOrientation++;break;case"f1c":i.modStatistics.ptInterest++;break;case"f1d":i.modStatistics.ptNoAnswer++}}if(s.users[t].survey.availableTime){let e=s.users[t].survey.availableTime;a[e]?a[e]++:a[e]=1}if(s.users[t].survey.planingStyle){switch(s.users[t].survey.planingStyle){case"planing-style-a":i.modStatistics.ptW1++;break;case"planing-style-b":i.modStatistics.ptW4++;break;case"planing-style-c":i.modStatistics.ptWA++;break;case"planing-style-d":i.modStatistics.ptWA2++;break;case"planing-style-e":i.modStatistics.ptWA4++;break;case"planing-style-f":i.modStatistics.ptWANA++}}}let r=0,o=0,l=0,d=0;if(s.users[t].milestones&&s.users[t].milestones.milestones){i.modStatistics.ptMS++,s.users[t].milestones=JSON.parse(s.users[t].milestones.milestones);let e=s.users[t].milestones.length;for(let e in s.users[t].milestones){switch(r++,s.users[t].milestones[e].status){case"progress":i.modStatistics.msProgessed++;break;case"ready":i.modStatistics.msReady++,l++;break;case"urgent":i.modStatistics.msUrgent++;break;case"missed":i.modStatistics.msMissed++,d++;break;case"reflected":i.modStatistics.msReflected++,i.modStatistics.msReady++,o++}}i.modStatistics.milestones+=e}e("#stUserList").length>0&&e("#stUserList tr:last").after(`<tr><td>${s.users[t].firstname}</td><td>${s.users[t].lastname}</td><td>${s.users[t].email}</td><td>${n}</td><td>${r}</td><td>${d}</td><td>${l}</td><td>${o}</td></tr>`)}let o=[],l="";for(let e in a)l+=`<tr><td>${e} SWS</td><td style="padding-right: 30px; text-align: right;">${a[e]}</td></tr>`,o.push({numb:parseInt(e),count:a[e]});e("#modWorkload tr:first").after(l),function(s,i,n){for(let e in i)i[e]<=0&&delete i[e];if(Object.keys(i).length<=0)return;let a=e(s);if(a.length>0){a.empty();let e=30,r=a.width()-8,o=r/2-2*e;r-=2*e;let l=t.select(s).append("svg").attr("width",r+2*e).attr("height",o+2*e),d=0,c=0;for(let e in i){let t=i[e];+t.numb>c&&(c=t.numb),+t.count>d&&(d=t.count)}let u=t.scaleLinear().range([o,0]).domain([0,d+1]).nice();l.append("g").attr("transform",`translate(${e}, ${e})`).attr("class","Yaxis").call(t.axisLeft(u).tickFormat(t.format(".0f")).ticks(d+1));let h=t.scaleLinear().range([0,r]).domain([0,c+1]).nice();l.append("g").attr("class","Xaxis").attr("transform",`translate(${e}, ${o+e})`).call(t.axisBottom(h).tickFormat(t.format(".0f")).ticks(c+1));let m=r/c/2;l.append("g").attr("transform",`translate(${e-m/2}, ${e})`).attr("class","bars").selectAll().data(i).enter().append("rect").style("fill",n).attr("x",e=>h(e.numb)).attr("y",e=>u(e.count)).attr("height",e=>o-u(e.count)).attr("width",m)}}("#stChartHR",o,"#003f5c");let d={Bearbeitung:i.modStatistics.msProgessed,Dringend:i.modStatistics.msUrgent,Abgeschlossen:i.modStatistics.msReady,Reflektiert:i.modStatistics.msReflected,Abgelaufen:i.modStatistics.msMissed};var r=["#003f5c","#ffa600","#bc5090","#58508d","#ff6361"];n("#stChartMS",d,r),d={"Prüfung":i.modStatistics.ptExam,Orientierung:i.modStatistics.ptOrientation,Interesse:i.modStatistics.ptInterest,"Keine Angabe":i.modStatistics.ptNoAnswer},n("#stChartTA",d,r),d={"Nur eine Woche":i.modStatistics.ptW1,"Nur vier Wochen":i.modStatistics.ptW4,"Semester eine Woche":i.modStatistics.ptWA,"Semester zwei Wochen":i.modStatistics.ptWA2,"Semester vier Wochen":i.modStatistics.ptWA4,"Keine Angabe":i.modStatistics.ptWANA},n("#stChartPS",d,r)}},e=>{console.log(e)})}catch(e){console.log(e)}},sendNotification:function(e,t){try{l.get_ws("notification",{courseid:parseInt(v.id,10),subject:"hello",short:"ss",text:"Hier steht deine Werbung"},(function(e){console.log(e)}))}catch(e){console.log(e)}},modUpdateUser:function(){let t=this,s=e("input.mru:checked");if(s.length<=0)return void this.modAlert("warning","Bitte wählen Sie einen Benutzer aus.");let i=e("#modResetUserMS").is(":checked"),n=e("#modResetUserPlan").is(":checked");if(!i&&!n)return void this.modAlert("warning","Bitte wählen Sie aus, was zurück gesetzt werden soll.");let a=[];s.each((function(){let s=+e(this).val();if("number"!=typeof s&&s<=0)return;let r=new Promise((e,a)=>{let r={courseid:parseInt(v.id,10),userid:parseInt(s,10)};i&&(r.milestones=[]),n&&(r.plan=[]),r=JSON.stringify(r),l.get_ws("updateuser",{data:r},(function(i){for(let i in t.modUsers)if(t.modUsers[i].id===s)return!0===t.modUsers[i].self?e(!0):e(!1)}))});a.push(r)})),Promise.all(a).then(e=>{for(let t in e)!0===e[t]&&location.reload();this.modAlert("success","Benutzerplanung zurückgesetzt")},e=>{this.modAlert("danger",e)})},userAutocomplete:async function(t,s){try{e("input.mru:not(:checked)").parent().remove();let t=e("div.userAutocomplete");if(t.children().length<=0&&(t.removeClass("bg-secondary"),t.removeClass("mb-3")),"string"!=typeof s||s.length<=0)return;if("object"!=typeof this.modUsers||this.modUsers.length<1){let e=await new Promise((e,t)=>{l.get_ws("getalluser",{courseid:parseInt(v.id,10)},(function(t){let s=JSON.parse(t.data);if(!s.user)throw new Error("Invalid Return");return e(s.user)}))});this.modUsers=e}s=s.toLowerCase();for(let i in this.modUsers){let n=this.modUsers[i];if(n.id=+n.id,"number"!=typeof n.id||n.id<0)continue;if(e("#mru-"+n.id).length>0)continue;let a="",r=!1;if(n.username&&(-1!==n.username.toLowerCase().indexOf(s)&&(r=!0),a+=a.length>0?" - "+n.username:n.username),n.name&&(-1!==n.name.toLowerCase().indexOf(s)&&(r=!0),a+=a.length>0?" - "+n.name:n.name),n.email&&(-1!==n.email.toLowerCase().indexOf(s)&&(r=!0),a+=a.length>0?" - "+n.email:n.email),r){t.children().length<=0&&(t.addClass("bg-secondary"),t.addClass("mb-3"));let s=e('<div class="form-check"></div>').appendTo(t);e('<input class="mru form-check-input" type="checkbox" value="'+n.id+'" id="mru-'+n.id+'" />').appendTo(s),e('<label class="form-check-label" for="modResetUsers" />').text(a).appendTo(s)}}}catch(e){console.log(e)}},getMilestonePlan:function(){try{let e=this;l.get_ws("userpreferences",{data:{setget:"get",courseid:parseInt(v.id,10),fieldname:"ladtopics_survey_results"}},(function(t){if("string"!=typeof t.response||t.response.length<=0)return;let s=JSON.parse(t.response);if("0"===s[0].value)return;let i=JSON.parse(s[0].value),n=i.objectives.toLowerCase(),a=i.planingStyle.toLowerCase(),r={from:v.startDate,to:v.endDate};Math.round((r.to-r.from)/6048e5);switch(n){case"f1a":n="exam";break;case"f1b":n="orientation";break;case"f1c":n="interest";break;default:n=null}"string"!=typeof n&&null===n||l.get_ws("getmilestoneplan",{data:{courseid:parseInt(v.id,10),plan:n}},(function(t){try{if("string"==typeof t.data&&t.data.length>0){let s=JSON.parse(t.data);if("object"!=typeof s||!Array.isArray(s))return;let i=null;switch(a){case"planing-style-a":i=1;break;case"planing-style-b":i=4;break;case"planing-style-c":i=1;break;case"planing-style-d":i=4;break;case"planing-style-e":return}if(4===i){let t=[],n=r.from.toISOString(),a=r.to.toISOString();n=o(n).set({hour:12}).toDate(),a=o(a).set({hour:12}).toDate(),t.push(n);let l=o(n).add(i,"w").toDate();for(;l<=a;)t.push(l),n=l,l=o(n).add(i,"w").toDate();s.forEach((function(s){s.start=o(s.start).toDate(),s.end=o(s.end).toDate(),s.mod=!0;for(let e in t)if(s.end<=t[e]){void 0!==t[e-1]?s.start=t[e-1]:s.start=t[e],s.end=t[e];break}let i=!1;for(let t in e.milestones)if(e.milestones[t].id===s.id){i=!0;break}i||e.milestones.push(s)}))}else s.forEach((function(t){t.start=o(t.start).toDate(),t.end=o(t.end).toDate(),t.mod=!0;let s=!1;for(let i in e.milestones)if(e.milestones[i].id===t.id){s=!0;break}s||e.milestones.push(t)}))}}catch(e){new p(e)}}))}))}catch(e){new p(e)}}}});window.onresize=function(e){S=document.getElementById("planing-component").offsetWidth,w.width=S-y.right,w.timeFilterChart.filterTime()}}}}));